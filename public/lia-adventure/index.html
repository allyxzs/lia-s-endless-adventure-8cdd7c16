<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lia Adventure</title>
    <meta name="description" content="Jogo 2D side-scroller com 7 personagens, 5 mundos e 30 fases!">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#ff6b9d;--primary-dark:#e0558a;--primary-glow:rgba(255,107,157,0.5);--secondary:#4dccbd;--secondary-dark:#3eb3a5;--danger:#ff6b6b;--warning:#ffb347;--bg-dark:#0d1b2a;--bg-darker:#06101a;--text-primary:#fff;--text-secondary:#a9d1ff;--gold:#ffd700;--xp-purple:#a855f7;--alice-orange:#e67e22;--vitoria-cyan:#00bcd4;--miguel-green:#4caf50;--lilia-purple:#9c27b0;--isabela-red:#8b0000;--gabriel-blue:#1565c0;--luccas-green:#2e7d32;--agatha-purple:#7b1fa2;--poiqui-black:#333;--yasmim-blue:#1a237e}
        html,body{height:100%;overflow:hidden}
        body{font-family:'Fredoka',sans-serif;background:linear-gradient(135deg,var(--bg-darker),var(--bg-dark),#1a2c4a);color:var(--text-primary);display:flex;align-items:center;justify-content:center;min-height:100vh}
        .game-wrapper{display:flex;flex-direction:column;align-items:center;width:100%;height:100%}
        .canvas-container{position:relative;width:100%;height:100%;overflow:hidden}
        canvas{display:block;width:100%;height:100%;background:var(--bg-dark);object-fit:contain}
        .hud-overlay{position:absolute;top:8px;left:8px;right:8px;display:flex;justify-content:space-between;align-items:flex-start;pointer-events:none;z-index:10}
        .hud-left,.hud-right{display:flex;gap:4px;flex-wrap:wrap}
        .hud-stat{background:rgba(0,0,0,0.7);padding:4px 8px;border-radius:8px;display:flex;align-items:center;gap:4px;border:1px solid rgba(255,255,255,0.15);backdrop-filter:blur(5px)}
        .hud-icon{font-size:.65rem}.hud-value{font-family:'Press Start 2P',cursive;font-size:.4rem;color:var(--gold)}
        .health-bar-container{width:50px;height:8px;background:rgba(0,0,0,0.7);border-radius:4px;overflow:hidden;border:1px solid rgba(255,255,255,0.2)}
        .health-bar{height:100%;background:linear-gradient(90deg,var(--danger),var(--warning));transition:width .3s;border-radius:3px}
        .xp-bar-container{width:40px;height:6px;background:rgba(0,0,0,0.7);border-radius:3px;overflow:hidden}
        .xp-bar{height:100%;background:linear-gradient(90deg,var(--xp-purple),#c084fc);transition:width .3s}
        .stage-indicator{position:absolute;top:8px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--primary),var(--secondary));padding:4px 12px;border-radius:10px;font-family:'Press Start 2P',cursive;font-size:.4rem;color:white;z-index:11}
        .mission-indicator{position:absolute;top:35px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);padding:3px 10px;border-radius:8px;font-size:.6rem;color:var(--text-secondary);z-index:11;max-width:80%;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .game-screen{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(6,16,26,0.98);backdrop-filter:blur(10px);z-index:100;opacity:0;pointer-events:none;transition:opacity .3s;padding:20px;overflow-y:auto}
        .game-screen.active{opacity:1;pointer-events:auto}
        #titleScreen{background:radial-gradient(ellipse at center,#1a2c4a,var(--bg-darker) 70%)}
        .title-logo{font-family:'Press Start 2P',cursive;font-size:clamp(1.5rem,5vw,3rem);color:var(--primary);text-shadow:0 0 30px var(--primary-glow),4px 4px 0 var(--primary-dark),-2px -2px 0 #fff;margin-bottom:50px;animation:tf 3s ease-in-out infinite;text-align:center}
        @keyframes tf{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
        .press-start{font-family:'Press Start 2P',cursive;font-size:clamp(.6rem,2vw,1rem);color:var(--text-primary);animation:bl 1s infinite;margin-bottom:30px}
        @keyframes bl{0%,100%{opacity:1}50%{opacity:.3}}
        .start-btn-big{font-family:'Press Start 2P',cursive;font-size:clamp(.8rem,2.5vw,1.2rem);padding:20px 60px;border:none;border-radius:60px;cursor:pointer;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:white;box-shadow:0 8px 0 #b03e6a;transition:all .2s}
        .start-btn-big:hover{transform:translateY(-3px)}.start-btn-big:active{transform:translateY(4px);box-shadow:0 4px 0 #b03e6a}
        .menu-title{font-family:'Press Start 2P',cursive;font-size:clamp(1rem,3vw,1.8rem);color:var(--primary);text-shadow:0 0 20px var(--primary-glow);margin-bottom:40px}
        .menu-options{display:flex;flex-direction:column;gap:15px;width:100%;max-width:350px}
        .menu-btn{font-family:'Press Start 2P',cursive;font-size:clamp(.5rem,1.5vw,.75rem);padding:18px 30px;border:3px solid transparent;border-radius:15px;cursor:pointer;transition:all .3s;text-align:center;width:100%}
        .menu-btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:white;box-shadow:0 5px 0 #b03e6a}
        .menu-btn-primary:hover{transform:translateY(-2px)}
        .menu-btn-google{background:linear-gradient(135deg,#4285f4,#356ac3);color:white;box-shadow:0 5px 0 #2a5298}
        .menu-btn-google:hover{transform:translateY(-2px)}
        .google-hint{font-size:.65rem;color:var(--text-secondary);margin-top:-5px;opacity:.8}
        #stageSelectScreen{padding:10px}
        .stage-select-header{display:flex;justify-content:space-between;align-items:center;width:100%;max-width:900px;margin-bottom:15px}
        .stage-select-title{font-family:'Press Start 2P',cursive;font-size:clamp(.7rem,2vw,1rem);color:var(--secondary)}
        .back-btn{font-family:'Press Start 2P',cursive;font-size:.5rem;padding:8px 15px;border:2px solid var(--text-secondary);border-radius:8px;background:transparent;color:var(--text-secondary);cursor:pointer}
        .back-btn:hover{border-color:var(--primary);color:var(--primary)}
        .player-stats-panel{display:flex;gap:20px;background:rgba(0,0,0,0.4);padding:10px 20px;border-radius:12px;margin-bottom:15px;flex-wrap:wrap;justify-content:center}
        .player-stat-item{text-align:center}.player-stat-value{font-family:'Press Start 2P',cursive;font-size:.7rem;color:var(--gold)}.player-stat-label{font-size:.6rem;color:var(--text-secondary)}
        .world-tabs{display:flex;gap:5px;margin-bottom:15px;flex-wrap:wrap;justify-content:center}
        .world-tab{font-family:'Press Start 2P',cursive;font-size:.35rem;padding:8px 12px;border:2px solid rgba(255,255,255,0.2);border-radius:8px;background:rgba(0,0,0,0.3);color:var(--text-secondary);cursor:pointer}
        .world-tab.active{border-color:var(--primary);background:var(--primary);color:white}
        .world-tab:hover:not(.active){border-color:var(--secondary)}
        .stage-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:10px;width:100%;max-width:900px;max-height:40vh;overflow-y:auto;padding:10px;background:rgba(0,0,0,0.3);border-radius:15px;-webkit-overflow-scrolling:touch}
        .stage-grid::-webkit-scrollbar{width:8px}.stage-grid::-webkit-scrollbar-track{background:rgba(0,0,0,0.3);border-radius:4px}.stage-grid::-webkit-scrollbar-thumb{background:var(--primary);border-radius:4px}
        
        .stage-info-panel{max-height:60vh;overflow-y:auto;-webkit-overflow-scrolling:touch}
        .stage-info-panel::-webkit-scrollbar{width:6px}.stage-info-panel::-webkit-scrollbar-track{background:rgba(0,0,0,0.2);border-radius:3px}.stage-info-panel::-webkit-scrollbar-thumb{background:var(--secondary);border-radius:3px}
        .stage-node{aspect-ratio:1;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;border:3px solid transparent;position:relative;min-width:70px}
        .stage-node.unlocked{background:linear-gradient(135deg,#2d4a6d,#3d5a80);border-color:var(--secondary)}
        .stage-node.unlocked:hover{transform:scale(1.05);border-color:var(--primary);box-shadow:0 0 20px var(--primary-glow)}
        .stage-node.completed{background:linear-gradient(135deg,#3a5a40,#588157);border-color:#7cb342}
        .stage-node.completed::after{content:'‚≠ê';position:absolute;top:-5px;right:-5px;font-size:.8rem}
        .stage-node.locked{background:rgba(0,0,0,0.4);border-color:rgba(255,255,255,0.1);cursor:not-allowed;opacity:.5}
        .stage-node.current{animation:cp 1.5s infinite}
        @keyframes cp{0%,100%{box-shadow:0 0 10px var(--primary-glow)}50%{box-shadow:0 0 25px var(--primary-glow),0 0 40px var(--primary-glow)}}
        .stage-number{font-family:'Press Start 2P',cursive;font-size:.8rem;color:white}.stage-stars{font-size:.5rem;margin-top:3px}
        .stage-info-panel{background:rgba(0,0,0,0.5);padding:15px;border-radius:12px;margin-top:15px;width:100%;max-width:900px;text-align:center}
        .stage-info-title{font-family:'Press Start 2P',cursive;font-size:.6rem;color:var(--primary);margin-bottom:8px}
        .stage-info-mission{font-size:.75rem;color:var(--text-secondary);margin-bottom:10px}
        .stage-info-rewards{display:flex;justify-content:center;gap:15px;margin-bottom:10px}
        .reward-item{display:flex;align-items:center;gap:5px;font-size:.65rem;color:var(--gold)}
        .play-stage-btn{font-family:'Press Start 2P',cursive;font-size:.6rem;padding:12px 30px;border:none;border-radius:25px;cursor:pointer;background:linear-gradient(135deg,var(--secondary),var(--secondary-dark));color:white;box-shadow:0 4px 0 #2a9d8f;transition:all .2s}
        .play-stage-btn:hover{transform:translateY(-2px)}
        .team-select-mini{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:15px;padding:8px 4px;max-width:100%}
        .team-char-mini{width:50px;height:62px;border-radius:10px;border:2px solid rgba(255,255,255,0.2);background:rgba(0,0,0,0.4);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;padding:2px}
        .team-char-mini.selected{border-color:var(--secondary);background:rgba(77,204,189,0.2)}
        .team-char-mini.primary-char{border-color:var(--gold);background:rgba(255,215,0,0.15);box-shadow:0 0 8px rgba(255,215,0,0.3)}
        .team-char-mini.locked{opacity:.4;cursor:not-allowed}
        .team-char-mini img{width:30px;height:30px;image-rendering:pixelated}
        .team-char-mini .cn{font-size:.35rem;color:var(--text-secondary);font-family:'Press Start 2P',cursive;margin-top:1px}
        .team-char-mini .cr{font-size:.25rem;color:var(--gold)}
        .results-screen{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(6,16,26,0.95);z-index:90;opacity:0;pointer-events:none;transition:opacity .5s;padding:20px}
        .results-screen.active{opacity:1;pointer-events:auto}
        .results-title{font-family:'Press Start 2P',cursive;font-size:clamp(1rem,3vw,1.5rem);margin-bottom:25px;text-shadow:0 0 20px currentColor}
        .results-title.victory{color:var(--secondary)}.results-title.defeat{color:var(--danger)}
        .results-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;width:100%;max-width:350px}
        .result-card{background:rgba(255,255,255,0.05);padding:12px;border-radius:10px;text-align:center;border:1px solid rgba(255,255,255,0.1)}
        .result-card-value{font-family:'Press Start 2P',cursive;font-size:.7rem;color:var(--gold)}
        .result-card-label{font-size:.6rem;color:var(--text-secondary);margin-top:4px}
        .result-xp{font-family:'Press Start 2P',cursive;font-size:.8rem;color:var(--xp-purple);margin-bottom:10px}
        .result-levelup{font-family:'Press Start 2P',cursive;font-size:1rem;color:var(--gold);animation:lup .5s ease-in-out infinite alternate;margin-bottom:10px}
        @keyframes lup{from{transform:scale(1)}to{transform:scale(1.1)}}
        .result-unlock{font-family:'Press Start 2P',cursive;font-size:.6rem;color:var(--secondary);background:rgba(77,204,189,0.15);padding:10px 20px;border-radius:10px;border:1px solid var(--secondary);margin-bottom:15px;animation:ug 1s ease-in-out infinite alternate}
        @keyframes ug{from{box-shadow:0 0 10px rgba(77,204,189,0.3)}to{box-shadow:0 0 25px rgba(77,204,189,0.6)}}
        .results-buttons{display:flex;gap:15px;flex-wrap:wrap;justify-content:center}
        .game-btn{font-family:'Press Start 2P',cursive;font-size:.6rem;padding:12px 25px;border:none;border-radius:50px;cursor:pointer;transition:all .2s;text-transform:uppercase;display:flex;align-items:center;gap:8px}
        .game-btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:white;box-shadow:0 5px 0 #b03e6a}
        .game-btn-primary:hover{transform:translateY(-2px)}
        .game-btn-secondary{background:linear-gradient(135deg,var(--secondary),var(--secondary-dark));color:white;box-shadow:0 5px 0 #2a9d8f}
        .game-btn-secondary:hover{transform:translateY(-2px)}
        .game-btn-danger{background:linear-gradient(135deg,var(--danger),#c0392b);color:white;box-shadow:0 5px 0 #962d22}
        .mobile-controls{display:none;position:fixed;bottom:10px;left:0;right:0;padding:0 10px;justify-content:space-between;z-index:1000}
        .mobile-btn-group{display:flex;gap:8px;align-items:flex-end}
        .mobile-btn{width:60px;height:60px;border-radius:50%;border:3px solid rgba(255,255,255,0.4);background:rgba(13,27,42,0.85);color:white;font-size:1.5rem;display:flex;align-items:center;justify-content:center;touch-action:manipulation;user-select:none;-webkit-user-select:none}
        .mobile-btn:active{background:rgba(255,107,157,0.5);transform:scale(.95)}
        .mobile-btn.attack-lia{background:rgba(255,107,157,0.4);border-color:var(--primary)}
        .mobile-btn.attack-sarah{background:rgba(231,76,60,0.4);border-color:#e74c3c}
        .mobile-btn.attack-dani{background:rgba(52,152,219,0.4);border-color:#3498db}
        .mobile-btn.attack-alice{background:rgba(230,126,34,0.4);border-color:var(--alice-orange)}
        .mobile-btn.attack-vitoria{background:rgba(0,188,212,0.4);border-color:var(--vitoria-cyan)}
        .mobile-btn.attack-miguel{background:rgba(76,175,80,0.4);border-color:var(--miguel-green)}
        .mobile-btn.attack-lilia{background:rgba(156,39,176,0.4);border-color:var(--lilia-purple)}
        .mobile-btn.attack-isabela{background:rgba(139,0,0,0.4);border-color:var(--isabela-red)}
        .mobile-btn.attack-gabriel{background:rgba(21,101,192,0.4);border-color:var(--gabriel-blue)}
        .mobile-btn.attack-luccas{background:rgba(46,125,50,0.4);border-color:var(--luccas-green)}
        .mobile-btn.attack-manuh{background:rgba(100,0,150,0.4);border-color:#7b1fa2}
        .mobile-btn.attack-julia{background:rgba(200,50,30,0.4);border-color:#c62828}
        .mobile-btn.attack-agatha{background:rgba(123,31,162,0.4);border-color:var(--agatha-purple)}
        .mobile-btn.attack-poiqui{background:rgba(51,51,51,0.4);border-color:var(--poiqui-black)}
        .mobile-btn.attack-yasmim{background:rgba(26,35,126,0.4);border-color:var(--yasmim-blue)}
        .mobile-btn.jump{background:rgba(77,204,189,0.4);border-color:var(--secondary)}
        .cooldown-overlay{position:absolute;bottom:80px;right:10px;background:rgba(0,0,0,0.8);padding:4px 10px;border-radius:8px;font-family:'Press Start 2P',cursive;font-size:.35rem;color:var(--warning);z-index:20;display:none}
        .mobile-btn.on-cooldown{opacity:.4;pointer-events:none}
        .support-cooldown{position:absolute;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);padding:4px 12px;border-radius:12px;font-family:'Press Start 2P',cursive;font-size:.4rem;color:#3498db;z-index:20;display:none}
        .combo-display{position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);font-family:'Press Start 2P',cursive;font-size:1.2rem;color:var(--gold);text-shadow:0 0 20px var(--gold),2px 2px 0 #b38600;pointer-events:none;opacity:0;z-index:50}
        .combo-display.active{animation:comboP .8s ease-out forwards}
        @keyframes comboP{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}20%{opacity:1;transform:translate(-50%,-50%) scale(1.2)}100%{opacity:0;transform:translate(-50%,-80%) scale(1)}}
        .pause-overlay{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Press Start 2P',cursive;font-size:1.5rem;color:var(--text-primary);text-shadow:0 0 20px var(--primary);z-index:60;display:none}
        .pause-overlay.active{display:block;animation:pp 1s ease-in-out infinite}
        @keyframes pp{0%,100%{opacity:.7}50%{opacity:1}}
        .loading-screen{position:absolute;top:0;left:0;right:0;bottom:0;background:var(--bg-darker);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:200}
        .loading-spinner{width:50px;height:50px;border:4px solid rgba(255,107,157,0.2);border-top-color:var(--primary);border-radius:50%;animation:sp 1s linear infinite;margin-bottom:15px}
        @keyframes sp{to{transform:rotate(360deg)}}
        .loading-text{font-family:'Press Start 2P',cursive;font-size:.6rem;color:var(--text-secondary);animation:pu 1.5s ease-in-out infinite}
        @keyframes pu{0%,100%{opacity:.5}50%{opacity:1}}
        .controls-panel{display:none;position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);padding:8px 20px;border-radius:10px;grid-template-columns:repeat(4,auto);gap:15px;z-index:20}
        .control-item{display:flex;align-items:center;gap:5px}.control-label{color:var(--text-secondary);font-size:.65rem}
        .key{display:inline-flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#3a4d6e,#2a3d5e);min-width:22px;height:20px;padding:0 5px;border-radius:4px;font-family:'Press Start 2P',cursive;font-size:.35rem;color:var(--text-primary);box-shadow:0 2px 0 #1a2639}
        .fog-overlay{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:5;background:radial-gradient(circle 200px at var(--px,50%) var(--py,50%),transparent 0%,rgba(0,0,0,0.85) 100%);opacity:0;transition:opacity .3s}
        .fog-overlay.active{opacity:1}
        @media(max-width:768px){.mobile-controls{display:flex}.stage-grid{grid-template-columns:repeat(5,1fr)}.stage-node{min-width:50px}.stage-number{font-size:.6rem}}
        @media(max-width:480px){.mobile-btn{width:55px;height:55px;font-size:1.3rem}.stage-grid{grid-template-columns:repeat(4,1fr)}}
        @media(min-width:769px){.controls-panel{display:grid}}
    </style>
</head>
<body>
    <div class="game-wrapper"><div class="canvas-container">
        <canvas id="gameCanvas"></canvas>
        <div class="fog-overlay" id="fogOverlay"></div>
        <div class="stage-indicator" id="stageIndicator" style="display:none;"></div>
        <div class="mission-indicator" id="missionIndicator" style="display:none;"></div>
        <div class="hud-overlay" id="hudOverlay" style="display:none;">
            <div class="hud-left"><div class="hud-stat"><span class="hud-icon">‚ù§Ô∏è</span><div class="health-bar-container"><div class="health-bar" id="healthBar" style="width:100%;"></div></div></div><div class="hud-stat"><span class="hud-icon">‚ö°</span><div class="xp-bar-container"><div class="xp-bar" id="xpBar" style="width:0%;"></div></div><span class="hud-value" id="levelDisplay">Lv.1</span></div></div>
            <div class="hud-right"><div class="hud-stat"><span class="hud-icon">üíÄ</span><span class="hud-value" id="killsDisplay">0/5</span></div><div class="hud-stat"><span class="hud-icon">‚≠ê</span><span class="hud-value" id="scoreDisplay">0</span></div></div>
        </div>
        <div class="support-cooldown" id="supportCooldown"></div>
        <div class="combo-display" id="comboDisplay"></div>
        <div class="pause-overlay" id="pauseOverlay">PAUSADO</div>
        <div class="loading-screen" id="loadingScreen"><div class="loading-spinner"></div><div class="loading-text">CARREGANDO...</div></div>
        <div class="game-screen active" id="titleScreen"><h1 class="title-logo">LIA ADVENTURE</h1><p class="press-start">PRESS START</p><button class="start-btn-big" id="titleStartBtn">START</button></div>
        <div class="game-screen" id="mainMenuScreen"><h2 class="menu-title">LIA ADVENTURE</h2><div class="menu-options"><button class="menu-btn menu-btn-primary" id="playGameBtn">INICIAR JOGO</button><button class="menu-btn menu-btn-google" id="googleLoginBtn">üîµ LOGAR CONTA GOOGLE</button><p class="google-hint">Logue para salvar progresso. Sem login, dados ser√£o perdidos.</p></div></div>
        <div class="game-screen" id="stageSelectScreen">
            <div class="stage-select-header"><h2 class="stage-select-title">SELECIONAR FASE</h2><button class="back-btn" id="backToMenuBtn">‚Üê VOLTAR</button></div>
            <div class="player-stats-panel"><div class="player-stat-item"><div class="player-stat-value" id="playerLevelStat">Lv. 1</div><div class="player-stat-label">N√≠vel</div></div><div class="player-stat-item"><div class="player-stat-value" id="playerXpStat">0</div><div class="player-stat-label">XP Total</div></div><div class="player-stat-item"><div class="player-stat-value" id="playerStarsStat">0</div><div class="player-stat-label">‚≠ê Estrelas</div></div></div>
            <div class="world-tabs" id="worldTabs"></div>
            <div class="stage-grid" id="stageGrid"></div>
            <div class="stage-info-panel" id="stageInfoPanel" style="display:none;"><div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:8px"><div class="stage-info-title" id="stageInfoTitle" style="margin-bottom:0"></div><button class="play-stage-btn" id="playStageBtn">INICIAR FASE</button></div><div class="stage-info-mission" id="stageInfoMission"></div><div class="stage-info-rewards"><div class="reward-item">üèÜ <span id="stageXpReward">50</span> XP</div><div class="reward-item">‚≠ê <span id="stageScoreReward">500</span> pts</div></div><div class="team-select-mini" id="teamSelectMini"></div></div>
        </div>
        <div class="results-screen" id="resultsScreen"><h2 class="results-title" id="resultsTitle"></h2><div class="results-grid" id="resultsGrid"></div><div class="result-xp" id="resultXp" style="display:none;"></div><div class="result-levelup" id="resultLevelUp" style="display:none;">üéâ LEVEL UP! üéâ</div><div class="result-unlock" id="resultUnlock" style="display:none;"></div><div class="results-buttons" id="resultsButtons"></div></div>
        <div class="controls-panel" id="controlsPanel"><div class="control-item"><span class="control-label">Mover:</span><span class="key">A</span><span class="key">D</span></div><div class="control-item"><span class="control-label">Pular:</span><span class="key">W</span></div><div class="control-item"><span class="control-label">Atacar:</span><span class="key">J</span></div><div class="control-item"><span class="control-label">Pausar:</span><span class="key">ESC</span></div></div>
    </div></div>
    <div class="mobile-controls" id="mobileControls">
        <div class="mobile-btn-group"><button class="mobile-btn" id="mobileLeft">‚óÄ</button><button class="mobile-btn" id="mobileRight">‚ñ∂</button></div>
        <div class="mobile-btn-group"><button class="mobile-btn jump" id="mobileJump">‚ñ≤</button><button class="mobile-btn attack-lia" id="mobileAttack">‚öî</button></div>
    </div>
<script>
const WORLDS=['Magewood Forest'];
function getBg(id){if(id<=6)return'background';if(id<=13)return'bg1';if(id<=20)return'bg2';if(id<=26)return'bg3';if(id<=28)return'bg4';return'bg5'}

const SD=[
{id:1,w:1,wn:'Magewood Forest',sw:1,n:'1-1',m:{type:'kill',text:'Derrote 5 esqueletos',target:5},et:['skeleton'],eh:40,ed:8,es:1.5,me:3,sr:2500,xp:50,sc:300},
{id:2,w:1,wn:'Magewood Forest',sw:2,n:'1-2',m:{type:'kill',text:'Derrote 8 esqueletos',target:8},et:['skeleton'],eh:45,ed:10,es:1.6,me:4,sr:2300,xp:80,sc:400},
{id:3,w:1,wn:'Magewood Forest',sw:3,n:'1-3',m:{type:'survive',text:'Sobreviva por 45 segundos',target:45},et:['skeleton','dog'],eh:50,ed:10,es:1.7,me:4,sr:2200,xp:100,sc:500},
{id:4,w:1,wn:'Magewood Forest',sw:4,n:'1-4',m:{type:'kill',text:'Derrote 10 inimigos',target:10},et:['skeleton','dog'],eh:55,ed:12,es:1.7,me:5,sr:2100,xp:120,sc:600},
{id:5,w:1,wn:'Magewood Forest',sw:5,n:'1-5',m:{type:'combo',text:'Alcance combo 4x',target:4},et:['skeleton','dog'],eh:50,ed:12,es:1.8,me:5,sr:2000,xp:140,sc:700},
{id:6,w:1,wn:'Magewood Forest',sw:6,n:'1-6',m:{type:'kill',text:'Derrote 15 inimigos + Mini-Boss',target:15,hasBoss:1},et:['skeleton','dog'],eh:60,ed:14,es:1.8,me:5,sr:1900,xp:200,sc:1000},
{id:7,w:1,wn:'Magewood Forest',sw:7,n:'1-7',m:{type:'kill',text:'üå´Ô∏è Neblina! Derrote 12',target:12},et:['skeleton','dog'],eh:65,ed:14,es:1.9,me:5,sr:1800,xp:220,sc:1100,fog:1},
{id:8,w:1,wn:'Magewood Forest',sw:8,n:'1-8',m:{type:'survive',text:'üõ°Ô∏è Defenda por 60 segundos!',target:60},et:['skeleton','dog'],eh:60,ed:16,es:2,me:6,sr:1700,xp:250,sc:1200},
{id:9,w:1,wn:'Magewood Forest',sw:9,n:'1-9',m:{type:'kill',text:'‚öîÔ∏è Inimigos com escudo! Derrote 14',target:14},et:['skeleton','dog','archer'],eh:80,ed:16,es:1.8,me:5,sr:1800,xp:270,sc:1300,se:1},
{id:10,w:1,wn:'Magewood Forest',sw:10,n:'1-10',m:{type:'kill',text:'üíÄ Mini-Boss Esqueleto Gigante!',target:10,hasBoss:1},et:['skeleton','dog','bigbone'],eh:70,ed:18,es:1.9,me:5,sr:1700,xp:300,sc:1500},
{id:11,w:1,wn:'Magewood Forest',sw:11,n:'1-11',m:{type:'kill',text:'üåø M√∫ltiplas rotas! Derrote 16',target:16},et:['skeleton','dog','archer'],eh:75,ed:18,es:2,me:6,sr:1600,xp:320,sc:1600},
{id:12,w:1,wn:'Magewood Forest',sw:12,n:'1-12',m:{type:'kill',text:'üßô Necromantes! Derrote 18',target:18},et:['skeleton','necromancer','dog'],eh:80,ed:20,es:2,me:6,sr:1500,xp:350,sc:1700},
{id:13,w:1,wn:'Magewood Forest',sw:13,n:'1-13',m:{type:'kill',text:'‚öîÔ∏è Ondas de ataque! Derrote 20',target:20},et:['skeleton','dog','archer'],eh:85,ed:20,es:2.1,me:7,sr:1400,xp:380,sc:1800},
{id:14,w:1,wn:'Magewood Forest',sw:14,n:'1-14',m:{type:'survive',text:'üß© Plataformas! Sobreviva 50s',target:50},et:['skeleton','archer'],eh:85,ed:22,es:2.1,me:5,sr:1500,xp:400,sc:1900},
{id:15,w:1,wn:'Magewood Forest',sw:15,n:'1-15',m:{type:'survive',text:'üî• Proteja a √°rea! 70 segundos',target:70},et:['skeleton','necromancer','dog'],eh:90,ed:22,es:2.1,me:7,sr:1300,xp:450,sc:2000},
{id:16,w:1,wn:'Magewood Forest',sw:16,n:'1-16',m:{type:'kill',text:'üí® Inimigos r√°pidos! Derrote 22',target:22},et:['dog','skeleton','archer'],eh:90,ed:24,es:2.8,me:7,sr:1200,xp:480,sc:2100},
{id:17,w:1,wn:'Magewood Forest',sw:17,n:'1-17',m:{type:'survive',text:'ü™® Plataformas m√≥veis! 55s',target:55},et:['skeleton','archer','necromancer'],eh:95,ed:24,es:2.2,me:6,sr:1400,xp:500,sc:2200},
{id:18,w:1,wn:'Magewood Forest',sw:18,n:'1-18',m:{type:'kill',text:'üéØ Emboscadas! Derrote 25',target:25},et:['skeleton','dog','archer','necromancer'],eh:100,ed:26,es:2.3,me:8,sr:1100,xp:530,sc:2300},
{id:19,w:1,wn:'Magewood Forest',sw:19,n:'1-19',m:{type:'kill',text:'üíÄüíÄ Dupla Mini-Boss!',target:15,hasBoss:1},et:['skeleton','bigbone'],eh:110,ed:28,es:2.2,me:6,sr:1300,xp:560,sc:2400},
{id:20,w:1,wn:'Magewood Forest',sw:20,n:'1-20',m:{type:'kill',text:'üßô‚Äç‚ôÇÔ∏è Necromante Elite!',target:20,hasBoss:1},et:['necromancer','skeleton','archer'],eh:110,ed:28,es:2.3,me:7,sr:1200,xp:600,sc:2500},
{id:21,w:1,wn:'Magewood Forest',sw:21,n:'1-21',m:{type:'kill',text:'üåë Floresta escura! Derrote 22',target:22},et:['skeleton','dog','necromancer'],eh:115,ed:30,es:2.3,me:7,sr:1200,xp:630,sc:2600,fog:1},
{id:22,w:1,wn:'Magewood Forest',sw:22,n:'1-22',m:{type:'kill',text:'üëª Inimigos invis√≠veis!',target:18},et:['skeleton','dog','archer'],eh:120,ed:30,es:2.4,me:6,sr:1300,xp:660,sc:2700,fog:1,ie:1},
{id:23,w:1,wn:'Magewood Forest',sw:23,n:'1-23',m:{type:'kill',text:'‚ùÑÔ∏è Destrua os totens!',target:15},et:['skeleton','necromancer','dog'],eh:120,ed:32,es:2.3,me:7,sr:1200,xp:700,sc:2800},
{id:24,w:1,wn:'Magewood Forest',sw:24,n:'1-24',m:{type:'survive',text:'üåßÔ∏è Chuva m√°gica! 80s',target:80},et:['skeleton','archer','necromancer','dog'],eh:125,ed:32,es:2,me:7,sr:1200,xp:730,sc:2900,slow:1},
{id:25,w:1,wn:'Magewood Forest',sw:25,n:'1-25',m:{type:'survive',text:'‚è≥ Sobreviv√™ncia longa! 90s',target:90},et:['skeleton','dog','archer','necromancer'],eh:130,ed:34,es:2.5,me:8,sr:1100,xp:760,sc:3000},
{id:26,w:1,wn:'Magewood Forest',sw:26,n:'1-26',m:{type:'kill',text:'‚öîÔ∏è Horda massiva! Derrote 25',target:25},et:['skeleton','dog','archer','bigbone'],eh:135,ed:34,es:2.5,me:8,sr:1000,xp:800,sc:3200},
{id:27,w:1,wn:'Magewood Forest',sw:27,n:'1-27',m:{type:'kill',text:'‚ö° Combate intenso!',target:30},et:['skeleton','dog','archer','necromancer'],eh:140,ed:36,es:2.8,me:9,sr:900,xp:850,sc:3400},
{id:28,w:1,wn:'Magewood Forest',sw:28,n:'1-28',m:{type:'kill',text:'‚ò†Ô∏è Todos os inimigos! Derrote 35',target:35},et:['skeleton','dog','archer','necromancer','bigbone'],eh:145,ed:36,es:2.6,me:9,sr:900,xp:900,sc:3600},
{id:29,w:1,wn:'Magewood Forest',sw:29,n:'1-29',m:{type:'kill',text:'üèöÔ∏è Ru√≠na principal! Derrote 35',target:35},et:['skeleton','dog','archer','necromancer','bigbone'],eh:150,ed:38,es:2.7,me:10,sr:850,xp:950,sc:3800},
{id:30,w:1,wn:'Magewood Forest',sw:30,n:'1-30',m:{type:'kill',text:'üëë BOSS: Warden of Bones!',target:20,hasBoss:1,isFinal:1},et:['skeleton','necromancer','bigbone'],eh:160,ed:40,es:2.5,me:8,sr:1000,xp:1500,sc:5000}
];

const XP={f(l){return Math.floor(100*Math.pow(1.5,l-1))},g(t){let l=1,n=0;while(t>=n+this.f(l)){n+=this.f(l);l++;if(l>99)break}return{level:l,currentXp:t-n,neededXp:this.f(l)}},b(l,s){return{attack:l*3,health:l*10,speed:Math.min(l*.1,3)}[s]||0}};
const C={W:1280,H:720,GY:620,G:.5,AR:.98,P:{w:70,h:100,ws:4,rs:7,ac:.45,dc:.35,jf:-14,jhf:-.5,mjh:200,ad:300,acd:400,dcd:1000,ar:90,ah:70,bh:100,ba:20},
S:{w:65,h:95,ps:10,ar:400,acd:600,ba:15},D:{w:70,h:100,sd:6000,scd:15000},MN:{w:65,h:95,ar:120,acd:6000,ba:16,frzC:.3,frzD:2000,atkBuf:1.3,bufDur:5000},JU:{w:65,h:95,flameR:200,acd:9000,ba:12,burnDmg:5,bdr:3000,healAmt:20,atkBuf:1.25,bufDur:5000},
A:{w:65,h:95,fr:150,bd:3,bdr:3000,bfd:5000,acd:8000},V:{w:65,h:95,fc:.25,fd:2000,s1c:5000,s2c:12000,s3c:10000},
M:{w:65,h:95,ps:12,acd:800,ba:18},L:{w:65,h:95,pr:160,hAmt:15,shAmt:20,atkBuff:1.3,burnDmg:4,bdr:4000,acd:10000},
GB:{w:65,h:95,rfl:1500,rcd:8000},LC:{w:65,h:95,shHP:40,shDur:10000,atkBuf:1.3,bufDur:6000,acd1:12000,acd2:10000,ps:10},
AG:{w:65,h:95,ba:50,acd:10000},PQ:{w:65,h:95,ba:15,flameR:180,burnDmg:6,bdr:3000,acd1:7000,acd2:12000,auraR:100,auraDmg:4,auraDur:6000},
YA:{w:65,h:95,ba:25,exR:160,acd:10000,shHP:35,atkBuf:1.3,bufDur:6000,burnDmg:5,bdr:3000,frzC:.4,frzD:2000}};

const G_={totalXp:0,pl:1,cx:0,xn:100,hs:1,ss:{},uc:{lia:1,sarah:1,dani:1,alice:1,vitoria:1,miguel:1,lilia:1,isabela:1,gabriel:1,luccas:1,manuh:1,julia:1,agatha:1,poiqui:1,yasmim:1},ts:0,cs:null,sel:['lia'],pc:'lia',
sit:0,dit:0,ait:0,vit:0,mit:0,lit:0,ibt:0,gbt:0,lut:0,mnt:0,jut:0,agt:0,pqt:0,yat:0,run:0,pau:0,sc:0,died:0,sk:0,ssc:0,sdt:0,smc:0,sst:0,co:0,lct:0,lsp:0,bo:0,
par:[],di:[],ssh:{x:0,y:0,i:0},keys:{},proj:[],
shA:0,shE:0,lsT:0,aBuf:0,aBufE:0,iSh:0,iShE:0,fCA:0,fCE:0,fCC:0,
lcSh:0,lcShHP:0,lcShE:0,
pqAura:0,pqAuraE:0,
pAtkLast:0,
login:0,fog:0,slow:0};

function save(){if(!G_.login)return;localStorage.setItem('liaSave',JSON.stringify({x:G_.totalXp,h:G_.hs,s:G_.ss,u:G_.uc,t:G_.ts}))}
function load(){if(!G_.login)return;const s=localStorage.getItem('liaSave');if(s){const d=JSON.parse(s);G_.totalXp=d.x||0;G_.hs=d.h||1;G_.ss=d.s||{};G_.uc=d.u||{lia:1};G_.ts=d.t||0;const l=XP.g(G_.totalXp);G_.pl=l.level;G_.cx=l.currentXp;G_.xn=l.neededXp}}

const cv=document.getElementById('gameCanvas'),ctx=cv.getContext('2d');
const el={};
['loadingScreen','titleScreen','mainMenuScreen','stageSelectScreen','resultsScreen','resultsTitle','resultsGrid','resultXp','resultLevelUp','resultUnlock','resultsButtons','hudOverlay','stageIndicator','missionIndicator','healthBar','xpBar','levelDisplay','killsDisplay','scoreDisplay','supportCooldown','comboDisplay','pauseOverlay','controlsPanel','mobileControls','worldTabs','stageGrid','stageInfoPanel','stageInfoTitle','stageInfoMission','stageXpReward','stageScoreReward','teamSelectMini','playerLevelStat','playerXpStat','playerStarsStat','fogOverlay'].forEach(id=>el[id]=document.getElementById(id));

function resize(){const c=cv.parentElement,ar=C.W/C.H;let w=c.clientWidth,h=w/ar;if(h>c.clientHeight){h=c.clientHeight;w=h*ar}cv.width=C.W;cv.height=C.H;cv.style.width=w+'px';cv.style.height=h+'px'}
window.addEventListener('resize',resize);resize();

let ac=null;
function iA(){if(!ac)ac=new(window.AudioContext||window.webkitAudioContext)()}
function pt(f,d,t='square',v=.1){if(!ac)return;const o=ac.createOscillator(),g=ac.createGain();o.type=t;o.frequency.value=f;g.gain.value=v;g.gain.exponentialRampToValueAtTime(.01,ac.currentTime+d);o.connect(g);g.connect(ac.destination);o.start();o.stop(ac.currentTime+d)}
const snd={jump:()=>pt(400,.1,'square',.08),atk:()=>pt(200,.15,'sawtooth',.1),hit:()=>pt(150,.1,'square',.12),dmg:()=>pt(100,.2,'sawtooth',.15),shield:()=>{pt(300,.1,'sine',.1);setTimeout(()=>pt(500,.15,'sine',.1),100)},shoot:()=>pt(600,.08,'sine',.08),combo:()=>pt(800,.1,'sine',.1),fire:()=>{pt(250,.2,'sawtooth',.12);setTimeout(()=>pt(350,.15,'sawtooth',.1),100)},ice:()=>{pt(700,.15,'sine',.1);setTimeout(()=>pt(900,.1,'sine',.08),100)},energy:()=>{pt(350,.1,'sine',.1);setTimeout(()=>pt(450,.08,'sine',.08),50);setTimeout(()=>pt(550,.08,'sine',.08),100)},purple:()=>{pt(300,.2,'sine',.12);setTimeout(()=>pt(500,.15,'sine',.1),100);setTimeout(()=>pt(400,.1,'sine',.08),200)},sc:()=>{pt(523,.15);setTimeout(()=>pt(659,.15),150);setTimeout(()=>pt(784,.2),300);setTimeout(()=>pt(1047,.3),450)},unlock:()=>{for(let i=0;i<5;i++)setTimeout(()=>pt(400+i*100,.1,'sine',.12),i*80)},lu:()=>{pt(523,.1);setTimeout(()=>pt(784,.1),100);setTimeout(()=>pt(1047,.2),200)},go:()=>{pt(200,.3,'sawtooth',.12);setTimeout(()=>pt(150,.4,'sawtooth',.1),300)}};

const img={};
const id_={playerIdle:'lia.png',playerWalk:'liawalk.png',playerRun:'liarun.png',playerJump:'liajump.png',playerAttack:'liaattacking.png',playerDamage:'liadamage.png',
sarahIdle:'sarah.png',sarahRun:'sarahrun.png',sarahJump:'sarahjump.png',sarahAttack:'sarahattack.png',sarahDamage:'sarahdamage.png',
daniIdle:'dani.png',daniRun:'danirun.png',daniJump:'danijump.png',daniDefense:'danidefense.png',daniDamage:'danidamage.png',
aliceIdle:'alice.png',aliceRun:'alicerun.png',aliceAttack:'aliceattack.png',aliceDamage:'alicedamage.png',
vitoriaIdle:'vitoria.png',vitoriaRun:'vitoriarun.png',vitoriaA1:'vitoriaattack1.png',vitoriaA2:'vitoriaattack2.png',vitoriaA3:'vitoriaattack3.png',
miguelIdle:'miguel.png',miguelRun:'miguelrun.png',miguelJump:'migueljump.png',miguelAttack:'miguelattack.png',miguelDamage:'migueldamage.png',
liliaIdle:'lilia.png',liliaRun:'liliarun.png',liliaJump:'liliajump.png',liliaAttack:'liliaattack.png',liliaDamage:'liliadamage.png',
isabelaIdle:'isabela.png',isabelaRun:'isabelarun.png',isabelaJump:'isabelajump.png',isabelaAttack:'isabelaattack.png',isabelaDamage:'isabeladamage.png',
gabrielIdle:'gabriel.png',gabrielRun:'gabrielrun.png',gabrielJump:'gabrieljump.png',gabrielDefense:'gabrieldefense.png',gabrielDamage:'gabrieldamage.png',
luccasIdle:'luccas.png',luccasRun:'luccasrun.png',luccasDamage:'luccasdamage.png',luccasAttack1:'luccasattack1.png',luccasAttack2:'luccasattack2.png',
manuhIdle:'manuh.png',manuhRun:'manuhrun.png',manuhJump:'manuhjump.png',manuhDamage:'manuhdamage.png',manuhAttack:'manuhattack1.png',
juliaIdle:'julia.png',juliaRun:'juliarun.png',juliaJump:'juliajump.png',juliaDamage:'juliadamage.png',juliaAttack:'juliaattack.png',
agathaIdle:'agatha.png',agathaRun:'agatharun.png',agathaJump:'agathajump.png',agathaDamage:'agathadamage.png',agathaAttack:'agathaattack.png',
poiquiIdle:'poiqui.png',poiquiRun:'poiquirun.png',poiquiDamage:'poiquidamage.png',poiquiAttack1:'poiquiattack1.png',poiquiAttack2:'poiquiattack2.png',
yasmimIdle:'yasmim.png',yasmimRun:'yasmimrun.png',yasmimJump:'yasmimjump.png',yasmimDamage:'yasmimdamage.png',yasmimDefense:'yasmimdefense.png',
skeleton:'skeleton.png',skeletonWL:'skeletonwalkl.png',skeletonWR:'skeletonwalkr.png',skeletonAtk:'skeletonattack.png',skeletonDmg:'skeletondamage.png',skeletonDead:'skeletonko.png',
dog:'edmf.png',archer:'bonearc.png',necromancer:'wizbon.png',bigbone:'bigbon.png',
background:'mapa.png',bg1:'bg_forest1.png',bg2:'bg_forest2.png',bg3:'bg_forest3.png',bg4:'bg_forest4.png',bg5:'bg_forest5.png'};
let il=0;const tl=Object.keys(id_).length;
function oil(){il++;if(il>=tl)el.loadingScreen.style.display='none'}
Object.entries(id_).forEach(([k,v])=>{img[k]=new Image();img[k].src=v;img[k].onload=oil;img[k].onerror=oil});
let curBg=null;let enemies=[];
function cc(a,b){return a.x<b.x+b.width&&a.x+a.width>b.x&&a.y<b.y+b.height&&a.y+a.height>b.y}

// ===== PLAYER =====
const P={x:100,y:0,w:C.P.w,h:C.P.h,vx:0,vy:0,hp:100,mhp:100,ap:20,gr:0,jmp:0,atk:0,dmg:0,run:0,fr:1,lat:0,ldt:0,jht:0,jp:0,
width:C.P.w,height:C.P.h,
reset(){const h=XP.b(G_.pl,'health'),a=XP.b(G_.pl,'attack');this.mhp=C.P.bh+h;this.hp=this.mhp;this.ap=C.P.ba+a;this.x=100;this.y=C.GY-this.h;this.vx=0;this.vy=0;this.gr=0;this.jmp=0;this.atk=0;this.dmg=0;this.fr=1;this.lat=0;this.ldt=0;this.jht=0;this.jp=0},
update(dt){const now=Date.now(),sb=XP.b(G_.pl,'speed');this.run=G_.keys['shift'];let ts=(this.run?C.P.rs:C.P.ws)+sb;if(G_.slow)ts*=.7;
if(G_.keys['a']||G_.keys['arrowleft']){this.vx=Math.max(this.vx-C.P.ac,-ts);this.fr=0}else if(G_.keys['d']||G_.keys['arrowright']){this.vx=Math.min(this.vx+C.P.ac,ts);this.fr=1}else{if(Math.abs(this.vx)<C.P.dc)this.vx=0;else this.vx+=this.vx>0?-C.P.dc:C.P.dc}
if(!this.gr)this.vx*=C.AR;if(this.jmp&&this.jp&&this.jht<C.P.mjh){this.vy+=C.P.jhf;this.jht+=dt}
this.vy+=C.G;this.x+=this.vx;this.y+=this.vy;
if(this.y>=C.GY-this.h){this.y=C.GY-this.h;this.vy=0;this.gr=1;this.jmp=0}else this.gr=0;
this.x=Math.max(0,Math.min(C.W-this.w,this.x));
if(this.atk&&now-this.lat>C.P.ad)this.atk=0;if(this.dmg&&now-this.ldt>300)this.dmg=0;
if(G_.fog){el.fogOverlay.style.setProperty('--px',(this.x+this.w/2)/C.W*100+'%');el.fogOverlay.style.setProperty('--py',(this.y+this.h/2)/C.H*100+'%')}},
jump(){if(this.gr&&!this.jmp){this.vy=C.P.jf;this.jmp=1;this.gr=0;this.jht=0;this.jp=1;snd.jump()}},
rj(){this.jp=0},
attack(){const now=Date.now();if(now-this.lat<C.P.acd)return;this.atk=1;this.lat=now;snd.atk();let a=this.ap;if(G_.aBuf&&now<G_.aBufE)a*=1.4;
const ab={x:this.fr?this.x+this.w-10:this.x-C.P.ar+10,y:this.y+20,width:C.P.ar,height:C.P.ah};let hit=0;
enemies.forEach(e=>{if(!e.dead&&cc(ab,e)){e.takeDmg(a);hit=1;if(G_.fCA&&now<G_.fCE&&Math.random()<G_.fCC&&!e.frz)e.freeze(C.V.fd);G_.fCC=Math.min((G_.fCC||0)+.05,.6)}});
if(hit){G_.co++;G_.lct=now;if(G_.co>G_.smc)G_.smc=G_.co;if(G_.co>1){showCombo(G_.co);snd.combo()}cP(this.fr?this.x+this.w+20:this.x-20,this.y+this.h/2,'#ff6b9d',5)}},
takeDmg(a){const now=Date.now();if(now-this.ldt<C.P.dcd)return;if(G_.shA)return;if(G_.iSh&&now<G_.iShE){cP(this.x+this.w/2,this.y+this.h/2,'#00bcd4',6);return}
if(G_.lcSh&&Date.now()<G_.lcShE){G_.lcShHP-=a;cP(this.x+this.w/2,this.y+this.h/2,'#2e7d32',4);if(G_.lcShHP<=0){G_.lcSh=0;cP(this.x+this.w/2,this.y,'#ff6b6b',8)}return}
this.hp-=a;this.dmg=1;this.ldt=now;G_.sdt+=a;snd.dmg();G_.ssh.i=8;G_.co=0;if(G_.fCA)G_.fCC=.05;
cDI(this.x+this.w/2,this.y,a);cP(this.x+this.w/2,this.y+this.h/2,'#ff6b6b',8);if(this.hp<=0){this.hp=0;gOver()}uHUD()},
draw(){ctx.save();const sp=pcSpr[G_.pc]||pcSpr.lia;let s=sp.idle;if(this.dmg)s=sp.damage;else if(this.atk)s=sp.attack;else if(!this.gr)s=sp.jump;else if(Math.abs(this.vx)>.5)s=this.run?sp.run:sp.walk;
ctx.fillStyle='rgba(0,0,0,0.3)';ctx.beginPath();ctx.ellipse(this.x+this.w/2,C.GY+5,this.w/2,10,0,0,Math.PI*2);ctx.fill();
if(G_.aBuf&&Date.now()<G_.aBufE){ctx.globalAlpha=.3+Math.sin(Date.now()*.01)*.15;ctx.fillStyle='#e67e22';ctx.beginPath();ctx.ellipse(this.x+this.w/2,this.y+this.h/2,this.w*.7,this.h*.6,0,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1}
if(G_.iSh&&Date.now()<G_.iShE){ctx.globalAlpha=.25;ctx.fillStyle='#00bcd4';ctx.beginPath();ctx.ellipse(this.x+this.w/2,this.y+this.h/2,this.w*.8,this.h*.65,0,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1}
if(!this.fr){ctx.scale(-1,1);ctx.drawImage(s,-this.x-this.w,this.y,this.w,this.h)}else ctx.drawImage(s,this.x,this.y,this.w,this.h);ctx.restore()}};

// ===== COMPANIONS =====
function fP(s,ox){const tx=P.x+(P.fr?ox:-ox),dx=tx-s.x;if(Math.abs(dx)>30){s.vx+=Math.sign(dx)*.35;s.vx=Math.max(-5,Math.min(5,s.vx));s.fr=dx>0?1:0}else s.vx*=.8;if(P.jmp&&s.y>=C.GY-s.h-5&&Math.abs(dx)<180){s.vy=-11;s.jmp=1}s.vy+=C.G;s.x+=s.vx;s.y+=s.vy;if(s.y>=C.GY-s.h){s.y=C.GY-s.h;s.vy=0;s.jmp=0}s.x=Math.max(0,Math.min(C.W-s.w,s.x))}
function dC(s,sp){ctx.save();ctx.fillStyle='rgba(0,0,0,0.25)';ctx.beginPath();ctx.ellipse(s.x+s.w/2,C.GY+3,s.w/2.5,8,0,0,Math.PI*2);ctx.fill();if(!s.fr){ctx.scale(-1,1);ctx.drawImage(sp,-s.x-s.w,s.y,s.w,s.h)}else ctx.drawImage(sp,s.x,s.y,s.w,s.h);ctx.restore()}

// Sarah
const sarah={x:150,y:0,w:65,h:95,vx:0,vy:0,fr:1,jmp:0,atk:0,lat:0,width:65,height:95,
reset(){this.x=150;this.y=C.GY-this.h;this.vx=0;this.vy=0;this.atk=0;this.lat=0},
update(){if(!G_.sit)return;fP(this,-90);const now=Date.now();if(this.atk&&now-this.lat>250)this.atk=0;
if(now-this.lat>C.S.acd){const a=enemies.filter(e=>!e.dead);if(a.length>0){const n=a.reduce((x,y)=>Math.abs(x.x-this.x)<Math.abs(y.x-this.x)?x:y);if(Math.abs(n.x-this.x)<C.S.ar){let d=C.S.ba+XP.b(G_.pl,'attack')*.5;if(G_.aBuf&&now<G_.aBufE)d*=1.4;G_.proj.push({x:this.x+this.w/2,y:this.y+this.h/2,vx:(n.x>this.x?1:-1)*C.S.ps,damage:d,life:1,size:8,type:'light'});this.lat=now;this.atk=1;this.fr=n.x>this.x?1:0;snd.shoot()}}}},
draw(){if(!G_.sit)return;let s=img.sarahIdle;if(this.atk)s=img.sarahAttack;else if(this.jmp)s=img.sarahJump;else if(Math.abs(this.vx)>.5)s=img.sarahRun;dC(this,s)}};

// Dani
const dani={x:80,y:0,w:70,h:100,vx:0,vy:0,fr:1,jmp:0,def:0,width:70,height:100,
reset(){this.x=80;this.y=C.GY-this.h;this.vx=0;this.vy=0;this.def=0},
activateShield(){if(!G_.dit)return;const now=Date.now();if(now-G_.lsT<C.D.scd)return;G_.shA=1;G_.shE=now+C.D.sd;G_.lsT=now;this.def=1;snd.shield();cP(this.x+this.w/2,this.y+this.h/2,'#3498db',12)},
update(){if(!G_.dit)return;fP(this,60);if(G_.shA&&Date.now()>G_.shE){G_.shA=0;this.def=0}},
draw(){if(!G_.dit)return;ctx.save();let s=img.daniIdle;if(this.def)s=img.daniDefense;else if(this.jmp)s=img.daniJump;else if(Math.abs(this.vx)>.5)s=img.daniRun;
ctx.fillStyle='rgba(0,0,0,0.25)';ctx.beginPath();ctx.ellipse(this.x+this.w/2,C.GY+3,this.w/2.5,8,0,0,Math.PI*2);ctx.fill();
if(G_.shA){ctx.globalAlpha=.3+Math.sin(Date.now()*.005)*.15;ctx.fillStyle='#3498db';ctx.beginPath();ctx.ellipse(this.x+this.w/2,this.y+this.h/2,100,80,0,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1}
if(!this.fr){ctx.scale(-1,1);ctx.drawImage(s,-this.x-this.w,this.y,this.w,this.h)}else ctx.drawImage(s,this.x,this.y,this.w,this.h);ctx.restore()}};

// Alice
const alice={x:200,y:0,w:65,h:95,vx:0,vy:0,fr:1,jmp:0,atk:0,lat:0,width:65,height:95,
reset(){this.x=200;this.y=C.GY-this.h;this.vx=0;this.vy=0;this.atk=0;this.lat=0},
fireAttack(){this.atk=1;this.lat=Date.now();snd.fire();const d=10+XP.b(G_.pl,'attack')*.3,cx=this.x+this.w/2,cy=this.y+this.h/2;
enemies.forEach(e=>{if(e.dead)return;const dist=Math.sqrt(Math.pow(e.x+e.width/2-cx,2)+Math.pow(e.y+e.height/2-cy,2));if(dist<C.A.fr){e.takeDmg(d);e.burnEnd=Date.now()+C.A.bdr;e.burnDmg=C.A.bd}});
G_.aBuf=1;G_.aBufE=Date.now()+C.A.bfd;for(let i=0;i<20;i++){const a=(Math.PI*2/20)*i;G_.par.push({x:cx+Math.cos(a)*30,y:cy+Math.sin(a)*20,vx:Math.cos(a)*3,vy:Math.sin(a)*2-1,life:40,ml:40,size:6,color:Math.random()>.5?'#e67e22':'#f39c12'})}},
update(){if(!G_.ait)return;fP(this,-120);const now=Date.now();if(this.atk&&now-this.lat>600)this.atk=0;if(now-this.lat>C.A.acd&&enemies.filter(e=>!e.dead).length>0)this.fireAttack()},
draw(){if(!G_.ait)return;ctx.save();let s=img.aliceIdle;if(this.atk){s=img.aliceAttack;ctx.globalAlpha=.25;const g=ctx.createRadialGradient(this.x+this.w/2,this.y+this.h/2,10,this.x+this.w/2,this.y+this.h/2,C.A.fr);g.addColorStop(0,'#e67e22');g.addColorStop(1,'transparent');ctx.fillStyle=g;ctx.beginPath();ctx.arc(this.x+this.w/2,this.y+this.h/2,C.A.fr,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1}else if(Math.abs(this.vx)>.5)s=img.aliceRun;dC(this,s);ctx.restore()}};

// Vit√≥ria
const vitoria={x:240,y:0,w:65,h:95,vx:0,vy:0,fr:1,jmp:0,cs:'idle',ls1:0,ls2:0,ls3:0,width:65,height:95,
reset(){this.x=240;this.y=C.GY-this.h;this.vx=0;this.vy=0;this.cs='idle';this.ls1=0;this.ls2=0;this.ls3=0},
s2(){if(!G_.vit)return;const now=Date.now();if(now-this.ls2<C.V.s2c)return;this.ls2=now;this.cs='a2';snd.ice();const cx=this.x+this.w/2,cy=this.y+this.h/2,d=18+XP.b(G_.pl,'attack')*.5;
enemies.forEach(e=>{if(e.dead)return;const dist=Math.sqrt(Math.pow(e.x+e.width/2-cx,2)+Math.pow(e.y+e.height/2-cy,2));if(dist<180){e.takeDmg(d);if(Math.random()<.5)e.freeze(C.V.fd)}});
G_.iSh=1;G_.iShE=now+4000;for(let i=0;i<25;i++){const a=(Math.PI*2/25)*i;G_.par.push({x:cx+Math.cos(a)*20,y:cy+Math.sin(a)*15,vx:Math.cos(a)*4,vy:Math.sin(a)*3-2,life:45,ml:45,size:5,color:Math.random()>.5?'#00bcd4':'#4dd0e1'})}},
s3(){if(!G_.vit)return;const now=Date.now();if(now-this.ls3<C.V.s3c)return;this.ls3=now;this.cs='a3';snd.ice();G_.fCA=1;G_.fCE=now+8000;G_.fCC=.05;G_.aBuf=1;G_.aBufE=now+8000;cP(this.x+this.w/2,this.y+this.h/2,'#4dd0e1',15)},
update(){if(!G_.vit)return;fP(this,-150);const now=Date.now();if(now-Math.max(this.ls1,this.ls2,this.ls3)>500)this.cs='idle';
const a=enemies.filter(e=>!e.dead);if(a.length>0&&now-this.ls1>C.V.s1c){const n=a.reduce((x,y)=>Math.abs(x.x-this.x)<Math.abs(y.x-this.x)?x:y);if(Math.abs(n.x-this.x)<350){this.ls1=now;this.cs='a1';this.fr=n.x>this.x?1:0;snd.ice();const d=12+XP.b(G_.pl,'attack')*.4;G_.proj.push({x:this.x+this.w/2,y:this.y+this.h/2,vx:(n.x>this.x?1:-1)*8,damage:d,life:1,size:12,type:'ice',fc:C.V.fc})}}},
draw(){if(!G_.vit)return;let s=img.vitoriaIdle;if(this.cs==='a1')s=img.vitoriaA1;else if(this.cs==='a2')s=img.vitoriaA2;else if(this.cs==='a3')s=img.vitoriaA3;else if(Math.abs(this.vx)>.5)s=img.vitoriaRun;dC(this,s)}};

// Miguel - shoots 3 green energy spheres
const miguel={x:180,y:0,w:65,h:95,vx:0,vy:0,fr:1,jmp:0,atk:0,lat:0,width:65,height:95,
reset(){this.x=180;this.y=C.GY-this.h;this.vx=0;this.vy=0;this.atk=0;this.lat=0},
shoot(){this.atk=1;this.lat=Date.now();snd.energy();const d=C.M.ba+XP.b(G_.pl,'attack')*.6;const dir=this.fr?1:-1;
if(G_.aBuf&&Date.now()<G_.aBufE){}// buff already applied in damage
for(let i=0;i<3;i++){setTimeout(()=>{let dmg=d;if(G_.aBuf&&Date.now()<G_.aBufE)dmg*=1.4;
G_.proj.push({x:this.x+this.w/2,y:this.y+this.h/2,vx:dir*C.M.ps,damage:dmg,life:1,size:10,type:'energy'})},i*100)}},
update(){if(!G_.mit)return;fP(this,-60);const now=Date.now();if(this.atk&&now-this.lat>400)this.atk=0;
if(now-this.lat>C.M.acd){const a=enemies.filter(e=>!e.dead);if(a.length>0){const n=a.reduce((x,y)=>Math.abs(x.x-this.x)<Math.abs(y.x-this.x)?x:y);if(Math.abs(n.x-this.x)<400){this.fr=n.x>this.x?1:0;this.shoot()}}}},
draw(){if(!G_.mit)return;let s=img.miguelIdle;if(this.atk)s=img.miguelAttack;else if(this.jmp)s=img.miguelJump;else if(Math.abs(this.vx)>.5)s=img.miguelRun;dC(this,s)}};

// Lilia - purple flame burst: heals/shields/buffs allies, burns enemies
const lilia={x:220,y:0,w:65,h:95,vx:0,vy:0,fr:1,jmp:0,atk:0,lat:0,width:65,height:95,
reset(){this.x=220;this.y=C.GY-this.h;this.vx=0;this.vy=0;this.atk=0;this.lat=0},
purpleBurst(){this.atk=1;this.lat=Date.now();snd.purple();const cx=this.x+this.w/2,cy=this.y+this.h/2;
// Heal player
P.hp=Math.min(P.mhp,P.hp+C.L.hAmt);
// Shield + attack buff
G_.iSh=1;G_.iShE=Date.now()+3000;
G_.aBuf=1;G_.aBufE=Date.now()+6000;
// Burn enemies in range
const d=8+XP.b(G_.pl,'attack')*.3;
enemies.forEach(e=>{if(e.dead)return;const dist=Math.sqrt(Math.pow(e.x+e.width/2-cx,2)+Math.pow(e.y+e.height/2-cy,2));if(dist<C.L.pr){e.burnEnd=Date.now()+C.L.bdr;e.burnDmg=C.L.burnDmg;e.takeDmg(d)}});
// Purple particles
for(let i=0;i<25;i++){const a=(Math.PI*2/25)*i;G_.par.push({x:cx+Math.cos(a)*25,y:cy+Math.sin(a)*20,vx:Math.cos(a)*4,vy:Math.sin(a)*3-2,life:50,ml:50,size:7,color:Math.random()>.5?'#9c27b0':'#ce93d8'})}},
update(){if(!G_.lit)return;fP(this,-180);const now=Date.now();if(this.atk&&now-this.lat>700)this.atk=0;
if(now-this.lat>C.L.acd&&enemies.filter(e=>!e.dead).length>0)this.purpleBurst()},
draw(){if(!G_.lit)return;ctx.save();let s=img.liliaIdle;if(this.atk){s=img.liliaAttack;ctx.globalAlpha=.2;const g=ctx.createRadialGradient(this.x+this.w/2,this.y+this.h/2,10,this.x+this.w/2,this.y+this.h/2,C.L.pr);g.addColorStop(0,'#9c27b0');g.addColorStop(1,'transparent');ctx.fillStyle=g;ctx.beginPath();ctx.arc(this.x+this.w/2,this.y+this.h/2,C.L.pr,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1}else if(Math.abs(this.vx)>.5)s=img.liliaRun;dC(this,s);ctx.restore()}};

// Isabela - bat swarm: damages and stuns enemies
const isabela={x:260,y:0,w:65,h:95,vx:0,vy:0,fr:1,jmp:0,atk:0,lat:0,width:65,height:95,
reset(){this.x=260;this.y=C.GY-this.h;this.vx=0;this.vy=0;this.atk=0;this.lat=0},
batSwarm(){this.atk=1;this.lat=Date.now();snd.fire();const cx=this.x+this.w/2,cy=this.y+this.h/2;
const d=14+XP.b(G_.pl,'attack')*.5;
for(let i=0;i<8;i++){const a=(Math.PI*2/8)*i;G_.proj.push({x:cx,y:cy,vx:Math.cos(a)*5,vy:Math.sin(a)*3,damage:d*.4,life:1,size:8,type:'bat'})}
enemies.forEach(e=>{if(e.dead)return;const dist=Math.sqrt(Math.pow(e.x+e.width/2-cx,2)+Math.pow(e.y+e.height/2-cy,2));if(dist<180){e.freeze(2000);e.takeDmg(d)}});
for(let i=0;i<15;i++){const a=(Math.PI*2/15)*i;G_.par.push({x:cx+Math.cos(a)*25,y:cy+Math.sin(a)*20,vx:Math.cos(a)*4,vy:Math.sin(a)*3-2,life:40,ml:40,size:6,color:Math.random()>.5?'#8b0000':'#4a0000'})}},
update(){if(!G_.ibt)return;fP(this,-200);const now=Date.now();if(this.atk&&now-this.lat>500)this.atk=0;
if(now-this.lat>8000&&enemies.filter(e=>!e.dead).length>0)this.batSwarm()},
draw(){if(!G_.ibt)return;ctx.save();let s=img.isabelaIdle;if(this.atk){s=img.isabelaAttack;ctx.globalAlpha=.2;ctx.fillStyle='#8b0000';ctx.beginPath();ctx.arc(this.x+this.w/2,this.y+this.h/2,100,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1}else if(this.jmp)s=img.isabelaJump;else if(Math.abs(this.vx)>.5)s=img.isabelaRun;dC(this,s);ctx.restore()}};

// Gabriel - Defender: reflects attacks with shield
const gabriel={x:280,y:0,w:65,h:95,vx:0,vy:0,fr:1,jmp:0,def:0,lat:0,width:65,height:95,
reset(){this.x=280;this.y=C.GY-this.h;this.vx=0;this.vy=0;this.def=0;this.lat=0},
reflect(){this.def=1;this.lat=Date.now();snd.shield();
const cx=this.x+this.w/2,cy=this.y+this.h/2;
// Reflect nearby enemy projectiles
G_.proj=G_.proj.map(p=>{if(p.isE){const dist=Math.sqrt(Math.pow(p.x-cx,2)+Math.pow(p.y-cy,2));if(dist<120){p.vx*=-1.5;p.isE=0;p.type='light';p.damage*=2;cP(p.x,p.y,'#64b5f6',6)}}return p});
// Damage nearby melee enemies
const d=12+XP.b(G_.pl,'attack')*.4;
enemies.forEach(e=>{if(e.dead)return;const dist=Math.sqrt(Math.pow(e.x+e.width/2-cx,2)+Math.pow(e.y+e.height/2-cy,2));if(dist<100){e.takeDmg(d);e.vx=Math.sign(e.x-cx)*8}});
for(let i=0;i<15;i++){const a=(Math.PI*2/15)*i;G_.par.push({x:cx+Math.cos(a)*30,y:cy+Math.sin(a)*20,vx:Math.cos(a)*5,vy:Math.sin(a)*3,life:35,ml:35,size:5,color:Math.random()>.5?'#1565c0':'#64b5f6'})}},
update(){if(!G_.gbt)return;fP(this,80);const now=Date.now();if(this.def&&now-this.lat>C.GB.rfl)this.def=0;
if(now-this.lat>C.GB.rcd){const a=enemies.filter(e=>!e.dead);const hasProj=G_.proj.some(p=>p.isE);if(a.length>0||hasProj)this.reflect()}},
draw(){if(!G_.gbt)return;ctx.save();let s=img.gabrielIdle;if(this.def){s=img.gabrielDefense;ctx.globalAlpha=.25;ctx.fillStyle='#1565c0';ctx.beginPath();ctx.arc(this.x+this.w/2,this.y+this.h/2,80,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1}else if(this.jmp)s=img.gabrielJump;else if(Math.abs(this.vx)>.5)s=img.gabrielRun;dC(this,s);ctx.restore()}};

// Luccas - Creative: throw shield (attack1) gives allies shield, kick shield (attack2) gives attack buff
const luccas={x:300,y:0,w:65,h:95,vx:0,vy:0,fr:1,jmp:0,atk:0,atkType:0,lat1:0,lat2:0,width:65,height:95,
reset(){this.x=300;this.y=C.GY-this.h;this.vx=0;this.vy=0;this.atk=0;this.atkType=0;this.lat1=0;this.lat2=0},
throwShield(){this.atk=1;this.atkType=1;this.lat1=Date.now();snd.shield();
// Give allies a shield
G_.lcSh=1;G_.lcShHP=C.LC.shHP+XP.b(G_.pl,'health')*.3;G_.lcShE=Date.now()+C.LC.shDur;
// Throw shield projectile
const d=15+XP.b(G_.pl,'attack')*.5;const dir=this.fr?1:-1;
G_.proj.push({x:this.x+this.w/2,y:this.y+this.h/2,vx:dir*C.LC.ps,damage:d,life:1,size:14,type:'shield'});
cP(this.x+this.w/2,this.y+this.h/2,'#2e7d32',10)},
kickShield(){this.atk=1;this.atkType=2;this.lat2=Date.now();snd.energy();
// Attack buff for allies
G_.aBuf=1;G_.aBufE=Date.now()+C.LC.bufDur;
// Kick shield projectile
const d=20+XP.b(G_.pl,'attack')*.6;const dir=this.fr?1:-1;
G_.proj.push({x:this.x+this.w/2,y:this.y+this.h/2,vx:dir*C.LC.ps*1.5,damage:d,life:1,size:16,type:'shield'});
cP(this.x+this.w/2,this.y+this.h/2,'#4caf50',12)},
update(){if(!G_.lut)return;fP(this,120);const now=Date.now();if(this.atk&&now-Math.max(this.lat1,this.lat2)>500)this.atk=0;
if(now-this.lat1>C.LC.acd1&&enemies.filter(e=>!e.dead).length>0)this.throwShield();
else if(now-this.lat2>C.LC.acd2&&now-this.lat1>3000&&enemies.filter(e=>!e.dead).length>0)this.kickShield()},
draw(){if(!G_.lut)return;ctx.save();let s=img.luccasIdle;let flipAtk=0;if(this.atk&&this.atkType===1){s=img.luccasAttack1;flipAtk=1}else if(this.atk&&this.atkType===2){s=img.luccasAttack2;flipAtk=1}else if(Math.abs(this.vx)>.5)s=img.luccasRun;
if(G_.lcSh&&Date.now()<G_.lcShE){ctx.globalAlpha=.15;ctx.fillStyle='#2e7d32';ctx.beginPath();ctx.ellipse(P.x+P.w/2,P.y+P.h/2,P.w*.8,P.h*.65,0,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1}
if(flipAtk){ctx.save();ctx.scale(-1,1);ctx.drawImage(s,-this.x-this.w,this.y,this.w,this.h);ctx.restore()}else{dC(this,s)}ctx.restore()}};

// Manuh - Creative: ice sword slash, freezes enemies + buffs nearest ally attack
const manuh={x:320,y:0,w:65,h:95,vx:0,vy:0,fr:1,jmp:0,atk:0,lat:0,width:65,height:95,
reset(){this.x=320;this.y=C.GY-this.h;this.vx=0;this.vy=0;this.atk=0;this.lat=0},
iceSlash(){this.atk=1;this.lat=Date.now();snd.ice();const cx=this.x+this.w/2,cy=this.y+this.h/2;
const d=C.MN.ba+XP.b(G_.pl,'attack')*.5;
enemies.forEach(e=>{if(e.dead)return;const dist=Math.sqrt(Math.pow(e.x+e.width/2-cx,2)+Math.pow(e.y+e.height/2-cy,2));if(dist<C.MN.ar){e.takeDmg(d);if(Math.random()<C.MN.frzC)e.freeze(C.MN.frzD)}});
// Buff nearest ally attack
G_.aBuf=1;G_.aBufE=Date.now()+C.MN.bufDur;
for(let i=0;i<18;i++){const a=(Math.PI*2/18)*i;G_.par.push({x:cx+Math.cos(a)*25,y:cy+Math.sin(a)*20,vx:Math.cos(a)*4,vy:Math.sin(a)*3-2,life:40,ml:40,size:5,color:Math.random()>.5?'#7b1fa2':'#81d4fa'})}},
update(){if(!G_.mnt)return;fP(this,-220);const now=Date.now();if(this.atk&&now-this.lat>500)this.atk=0;
if(now-this.lat>C.MN.acd&&enemies.filter(e=>!e.dead).length>0)this.iceSlash()},
draw(){if(!G_.mnt)return;ctx.save();let s=img.manuhIdle;if(this.atk){s=img.manuhAttack;ctx.globalAlpha=.2;ctx.fillStyle='#7b1fa2';ctx.beginPath();ctx.arc(this.x+this.w/2,this.y+this.h/2,C.MN.ar,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1}else if(this.jmp)s=img.manuhJump;else if(Math.abs(this.vx)>.5)s=img.manuhRun;dC(this,s);ctx.restore()}};

// Julia - Support: flame burst heals allies, burns enemies, buffs attack
const julia={x:340,y:0,w:65,h:95,vx:0,vy:0,fr:1,jmp:0,atk:0,lat:0,width:65,height:95,
reset(){this.x=340;this.y=C.GY-this.h;this.vx=0;this.vy=0;this.atk=0;this.lat=0},
flameBurst(){this.atk=1;this.lat=Date.now();snd.fire();const cx=this.x+this.w/2,cy=this.y+this.h/2;
const d=C.JU.ba+XP.b(G_.pl,'attack')*.4;
// Burn and damage enemies in range
enemies.forEach(e=>{if(e.dead)return;const dist=Math.sqrt(Math.pow(e.x+e.width/2-cx,2)+Math.pow(e.y+e.height/2-cy,2));if(dist<C.JU.flameR){e.takeDmg(d);e.burnEnd=Date.now()+C.JU.bdr;e.burnDmg=C.JU.burnDmg}});
// Heal player
P.hp=Math.min(P.mhp,P.hp+C.JU.healAmt);
// Buff allies attack
G_.aBuf=1;G_.aBufE=Date.now()+C.JU.bufDur;
for(let i=0;i<22;i++){const a=(Math.PI*2/22)*i;G_.par.push({x:cx+Math.cos(a)*30,y:cy+Math.sin(a)*20,vx:Math.cos(a)*5,vy:Math.sin(a)*3-2,life:45,ml:45,size:6,color:Math.random()>.5?'#ff6f00':'#ffd600'})}},
update(){if(!G_.jut)return;fP(this,150);const now=Date.now();if(this.atk&&now-this.lat>600)this.atk=0;
if(now-this.lat>C.JU.acd&&enemies.filter(e=>!e.dead).length>0)this.flameBurst()},
draw(){if(!G_.jut)return;ctx.save();let s=img.juliaIdle;if(this.atk){s=img.juliaAttack;ctx.globalAlpha=.25;const g=ctx.createRadialGradient(this.x+this.w/2,this.y+this.h/2,10,this.x+this.w/2,this.y+this.h/2,C.JU.flameR);g.addColorStop(0,'#ff6f00');g.addColorStop(1,'transparent');ctx.fillStyle=g;ctx.beginPath();ctx.arc(this.x+this.w/2,this.y+this.h/2,C.JU.flameR,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1}else if(this.jmp)s=img.juliaJump;else if(Math.abs(this.vx)>.5)s=img.juliaRun;dC(this,s);ctx.restore()}};

// Agatha - Attacker: light beam that pierces everything, 10s cooldown
const agatha={x:360,y:0,w:65,h:95,vx:0,vy:0,fr:1,jmp:0,atk:0,lat:0,width:65,height:95,
reset(){this.x=360;this.y=C.GY-this.h;this.vx=0;this.vy=0;this.atk=0;this.lat=0},
lightBeam(){this.atk=1;this.lat=Date.now();snd.energy();const d=C.AG.ba+XP.b(G_.pl,'attack')*.8;
// Pierce ALL enemies
enemies.forEach(e=>{if(!e.dead)e.takeDmg(d)});
// Visual beam
const cx=this.x+this.w/2,cy=this.y+this.h/2;
for(let i=0;i<30;i++){G_.par.push({x:cx+(this.fr?1:-1)*i*40,y:cy+(Math.random()-.5)*20,vx:(this.fr?1:-1)*8,vy:(Math.random()-.5)*2,life:30,ml:30,size:8,color:Math.random()>.5?'#ffd700':'#fff9c4'})}},
update(){if(!G_.agt)return;fP(this,-240);const now=Date.now();if(this.atk&&now-this.lat>800)this.atk=0;
if(now-this.lat>C.AG.acd&&enemies.filter(e=>!e.dead).length>0)this.lightBeam()},
draw(){if(!G_.agt)return;ctx.save();let s=img.agathaIdle;if(this.atk){s=img.agathaAttack;ctx.globalAlpha=.3;ctx.fillStyle='#ffd700';const bx=this.fr?this.x+this.w:this.x-C.W;ctx.fillRect(Math.min(this.x+this.w/2,bx),this.y+this.h/3,Math.abs(bx-this.x-this.w/2),20);ctx.globalAlpha=1}else if(this.jmp)s=img.agathaJump;else if(Math.abs(this.vx)>.5)s=img.agathaRun;dC(this,s);ctx.restore()}};

// Poiqui - Attacker: flame blast (attack1) + fire aura recharge (attack2)
const poiqui={x:380,y:0,w:65,h:95,vx:0,vy:0,fr:1,jmp:0,atk:0,atkType:0,lat1:0,lat2:0,width:65,height:95,
reset(){this.x=380;this.y=C.GY-this.h;this.vx=0;this.vy=0;this.atk=0;this.atkType=0;this.lat1=0;this.lat2=0},
flameBlast(){this.atk=1;this.atkType=1;this.lat1=Date.now();snd.fire();const cx=this.x+this.w/2,cy=this.y+this.h/2;
const d=C.PQ.ba+XP.b(G_.pl,'attack')*.5;const dir=this.fr?1:-1;
// Flame projectile stream
for(let i=0;i<5;i++){setTimeout(()=>{G_.proj.push({x:cx,y:cy+(Math.random()-.5)*30,vx:dir*(10+i*2),damage:d,life:1,size:10,type:'fire'})},i*80)}
enemies.forEach(e=>{if(e.dead)return;const dist=Math.sqrt(Math.pow(e.x+e.width/2-cx,2)+Math.pow(e.y+e.height/2-cy,2));if(dist<C.PQ.flameR){e.burnEnd=Date.now()+C.PQ.bdr;e.burnDmg=C.PQ.burnDmg}});
for(let i=0;i<15;i++){const a=(Math.PI*2/15)*i;G_.par.push({x:cx+Math.cos(a)*20,y:cy+Math.sin(a)*15,vx:Math.cos(a)*5*dir,vy:Math.sin(a)*3,life:35,ml:35,size:6,color:Math.random()>.5?'#ff6f00':'#ff8f00'})}},
fireAura(){this.atk=1;this.atkType=2;this.lat2=Date.now();snd.fire();
G_.pqAura=1;G_.pqAuraE=Date.now()+C.PQ.auraDur;
cP(this.x+this.w/2,this.y+this.h/2,'#ff6f00',15)},
update(){if(!G_.pqt)return;fP(this,180);const now=Date.now();if(this.atk&&now-Math.max(this.lat1,this.lat2)>500)this.atk=0;
// Fire aura damage
if(G_.pqAura&&now<G_.pqAuraE){enemies.forEach(e=>{if(e.dead)return;const dist=Math.sqrt(Math.pow(e.x+e.width/2-this.x-this.w/2,2)+Math.pow(e.y+e.height/2-this.y-this.h/2,2));if(dist<C.PQ.auraR){e.burnEnd=now+1000;e.burnDmg=C.PQ.auraDmg}})}else if(G_.pqAura&&now>=G_.pqAuraE)G_.pqAura=0;
if(now-this.lat1>C.PQ.acd1&&enemies.filter(e=>!e.dead).length>0)this.flameBlast();
else if(now-this.lat2>C.PQ.acd2&&now-this.lat1>3000)this.fireAura()},
draw(){if(!G_.pqt)return;ctx.save();let s=img.poiquiIdle;if(this.atk&&this.atkType===1)s=img.poiquiAttack1;else if(this.atk&&this.atkType===2){s=img.poiquiAttack2;ctx.globalAlpha=.2;ctx.fillStyle='#ff6f00';ctx.beginPath();ctx.arc(this.x+this.w/2,this.y+this.h/2,C.PQ.auraR,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1}else if(Math.abs(this.vx)>.5)s=img.poiquiRun;
if(G_.pqAura&&Date.now()<G_.pqAuraE){ctx.globalAlpha=.15+Math.sin(Date.now()*.01)*.1;ctx.fillStyle='#ff6f00';ctx.beginPath();ctx.arc(this.x+this.w/2,this.y+this.h/2,C.PQ.auraR,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1}
dC(this,s);ctx.restore()}};

// Yasmim - Defender: dual ice/fire explosion
const yasmim={x:400,y:0,w:65,h:95,vx:0,vy:0,fr:1,jmp:0,def:0,lat:0,width:65,height:95,
reset(){this.x=400;this.y=C.GY-this.h;this.vx=0;this.vy=0;this.def=0;this.lat=0},
dualExplosion(){this.def=1;this.lat=Date.now();snd.ice();snd.fire();const cx=this.x+this.w/2,cy=this.y+this.h/2;
const d=C.YA.ba+XP.b(G_.pl,'attack')*.5;
// Ice explosion left
const iceX=cx-80;
enemies.forEach(e=>{if(e.dead)return;const dist=Math.sqrt(Math.pow(e.x+e.width/2-iceX,2)+Math.pow(e.y+e.height/2-cy,2));if(dist<C.YA.exR){e.takeDmg(d);if(Math.random()<C.YA.frzC)e.freeze(C.YA.frzD)}});
for(let i=0;i<15;i++){const a=(Math.PI*2/15)*i;G_.par.push({x:iceX+Math.cos(a)*30,y:cy+Math.sin(a)*25,vx:Math.cos(a)*5,vy:Math.sin(a)*4-2,life:40,ml:40,size:6,color:Math.random()>.5?'#00bcd4':'#80deea'})}
// Fire explosion right
const fireX=cx+80;
enemies.forEach(e=>{if(e.dead)return;const dist=Math.sqrt(Math.pow(e.x+e.width/2-fireX,2)+Math.pow(e.y+e.height/2-cy,2));if(dist<C.YA.exR){e.takeDmg(d);e.burnEnd=Date.now()+C.YA.bdr;e.burnDmg=C.YA.burnDmg}});
for(let i=0;i<15;i++){const a=(Math.PI*2/15)*i;G_.par.push({x:fireX+Math.cos(a)*30,y:cy+Math.sin(a)*25,vx:Math.cos(a)*5,vy:Math.sin(a)*4-2,life:40,ml:40,size:6,color:Math.random()>.5?'#ff6f00':'#ffd600'})}
// Shield + attack buff for allies
G_.lcSh=1;G_.lcShHP=C.YA.shHP+XP.b(G_.pl,'health')*.3;G_.lcShE=Date.now()+8000;
G_.aBuf=1;G_.aBufE=Date.now()+C.YA.bufDur;
cP(cx,cy,'#1a237e',12)},
update(){if(!G_.yat)return;fP(this,100);const now=Date.now();if(this.def&&now-this.lat>1500)this.def=0;
if(now-this.lat>C.YA.acd&&enemies.filter(e=>!e.dead).length>0)this.dualExplosion()},
draw(){if(!G_.yat)return;ctx.save();let s=img.yasmimIdle;if(this.def){s=img.yasmimDefense;ctx.globalAlpha=.2;ctx.fillStyle='#00bcd4';ctx.beginPath();ctx.arc(this.x+this.w/2-80,this.y+this.h/2,C.YA.exR*.6,0,Math.PI*2);ctx.fill();ctx.fillStyle='#ff6f00';ctx.beginPath();ctx.arc(this.x+this.w/2+80,this.y+this.h/2,C.YA.exR*.6,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1}else if(this.jmp)s=img.yasmimJump;else if(Math.abs(this.vx)>.5)s=img.yasmimRun;dC(this,s);ctx.restore()}};

// Helper: sync companion position to player for primary attacks
function syncToP(c){c.x=P.x;c.y=P.y;c.fr=P.fr}

// Player character sprite map (for primary character rendering)
const pcSpr={
lia:{idle:img.playerIdle,walk:img.playerWalk,run:img.playerRun,jump:img.playerJump,attack:img.playerAttack,damage:img.playerDamage},
sarah:{idle:img.sarahIdle,walk:img.sarahRun,run:img.sarahRun,jump:img.sarahJump,attack:img.sarahAttack,damage:img.sarahDamage},
dani:{idle:img.daniIdle,walk:img.daniRun,run:img.daniRun,jump:img.daniJump,attack:img.daniDefense,damage:img.daniDamage},
alice:{idle:img.aliceIdle,walk:img.aliceRun,run:img.aliceRun,jump:img.aliceIdle,attack:img.aliceAttack,damage:img.aliceDamage},
vitoria:{idle:img.vitoriaIdle,walk:img.vitoriaRun,run:img.vitoriaRun,jump:img.vitoriaIdle,attack:img.vitoriaA1,damage:img.vitoriaIdle},
miguel:{idle:img.miguelIdle,walk:img.miguelRun,run:img.miguelRun,jump:img.miguelJump,attack:img.miguelAttack,damage:img.miguelDamage},
lilia:{idle:img.liliaIdle,walk:img.liliaRun,run:img.liliaRun,jump:img.liliaJump,attack:img.liliaAttack,damage:img.liliaDamage},
isabela:{idle:img.isabelaIdle,walk:img.isabelaRun,run:img.isabelaRun,jump:img.isabelaJump,attack:img.isabelaAttack,damage:img.isabelaDamage},
gabriel:{idle:img.gabrielIdle,walk:img.gabrielRun,run:img.gabrielRun,jump:img.gabrielJump,attack:img.gabrielDefense,damage:img.gabrielDamage},
luccas:{idle:img.luccasIdle,walk:img.luccasRun,run:img.luccasRun,jump:img.luccasIdle,attack:img.luccasAttack1,damage:img.luccasDamage},
manuh:{idle:img.manuhIdle,walk:img.manuhRun,run:img.manuhRun,jump:img.manuhJump,attack:img.manuhAttack,damage:img.manuhDamage},
julia:{idle:img.juliaIdle,walk:img.juliaRun,run:img.juliaRun,jump:img.juliaJump,attack:img.juliaAttack,damage:img.juliaDamage},
agatha:{idle:img.agathaIdle,walk:img.agathaRun,run:img.agathaRun,jump:img.agathaJump,attack:img.agathaAttack,damage:img.agathaDamage},
poiqui:{idle:img.poiquiIdle,walk:img.poiquiRun,run:img.poiquiRun,jump:img.poiquiIdle,attack:img.poiquiAttack1,damage:img.poiquiDamage},
yasmim:{idle:img.yasmimIdle,walk:img.yasmimRun,run:img.yasmimRun,jump:img.yasmimJump,attack:img.yasmimDefense,damage:img.yasmimDamage}};

// ===== ENEMY =====
function gEI(t){return{skeleton:img.skeleton,dog:img.dog,archer:img.archer,necromancer:img.necromancer,bigbone:img.bigbone}[t]||img.skeleton}
class Enemy{
constructor(x,st,type){this.type=type||'skeleton';const sz={skeleton:[60,80],dog:[70,55],archer:[55,80],necromancer:[55,85],bigbone:[90,120]}[this.type]||[60,80];this.width=sz[0];this.height=sz[1];this.x=x;this.y=C.GY-this.height;this.vx=0;this.vy=0;let hm=1,dm=1,sm=1;if(this.type==='dog'){hm=.6;sm=1.8;dm=.8}if(this.type==='archer'){hm=.7;dm=1.2;sm=.7}if(this.type==='necromancer'){hm=1.2;dm=1.5;sm=.6}if(this.type==='bigbone'){hm=3;dm=2;sm=.5}
this.hp=st.eh*hm;this.mhp=this.hp;this.dmg_=st.ed*dm;this.spd=st.es*sm;this.dead=0;this.isDmg=0;this.isAtk=0;this.fr=x<C.W/2?1:0;this.lat=0;this.ldt=0;this.dt=0;this.acd=this.type==='necromancer'?2000:this.type==='archer'?1800:1200;
this.burnEnd=0;this.burnDmg=0;this.lbt=0;this.frz=0;this.frzE=0;this.sh=st.se&&Math.random()>.5;if(this.sh)this.hp*=1.5;this.inv=st.ie&&this.type==='skeleton'}
freeze(d){this.frz=1;this.frzE=Date.now()+d;cP(this.x+this.width/2,this.y+this.height/2,'#00bcd4',8)}
update(){if(this.dead)return;const now=Date.now();if(now<this.burnEnd&&now-this.lbt>500){this.hp-=this.burnDmg;this.lbt=now;cP(this.x+this.width/2,this.y,'#e67e22',3);cDI(this.x+this.width/2,this.y,this.burnDmg,'#e67e22');if(this.hp<=0){this.die();return}}
if(this.frz){if(now>this.frzE)this.frz=0;else return}if(this.isDmg&&now-this.ldt>200)this.isDmg=0;if(this.isAtk&&now-this.lat>400)this.isAtk=0;
const dx=P.x-this.x;this.fr=dx>0?1:0;const ar=this.type==='archer'||this.type==='necromancer'?200:50;
if(Math.abs(dx)>ar)this.vx=Math.sign(dx)*this.spd;else{this.vx=0;if(now-this.lat>this.acd){this.isAtk=1;this.lat=now;if(this.type==='archer'||this.type==='necromancer')G_.proj.push({x:this.x+this.width/2,y:this.y+this.height/3,vx:Math.sign(dx)*7,damage:this.dmg_*.6,life:1,size:6,type:'enemy',isE:1});else if(cc({x:this.x-20,y:this.y,width:this.width+40,height:this.height},P))P.takeDmg(this.dmg_)}}
this.x+=this.vx;this.x=Math.max(-50,Math.min(C.W+50,this.x))}
takeDmg(a){if(this.sh)a*=.6;this.hp-=a;this.isDmg=1;this.ldt=Date.now();snd.hit();cDI(this.x+this.width/2,this.y,Math.round(a));cP(this.x+this.width/2,this.y+this.height/2,'#fff',4);if(this.hp<=0)this.die()}
die(){this.dead=1;this.dt=Date.now();G_.sk++;const sc=100*(1+G_.co*.2);G_.ssc+=Math.floor(sc);cP(this.x+this.width/2,this.y+this.height/2,'#ffd700',10);chkComplete()}
draw(){if(this.dead){if(Date.now()-this.dt<600){ctx.save();ctx.globalAlpha=Math.max(0,1-(Date.now()-this.dt)/600);ctx.drawImage(this.type==='skeleton'?img.skeletonDead:gEI(this.type),this.x,this.y,this.width,this.height);ctx.restore()}return}
ctx.save();let s=gEI(this.type);if(this.type==='skeleton'){if(this.isDmg)s=img.skeletonDmg;else if(this.isAtk)s=img.skeletonAtk;else if(Math.abs(this.vx)>.3)s=this.fr?img.skeletonWR:img.skeletonWL}
if(this.inv){const d=Math.abs(this.x-P.x);ctx.globalAlpha=d<150?.8:.1}
ctx.fillStyle='rgba(0,0,0,0.2)';ctx.beginPath();ctx.ellipse(this.x+this.width/2,C.GY+3,this.width/2,7,0,0,Math.PI*2);ctx.fill();
if(this.frz){ctx.fillStyle='rgba(0,188,212,0.3)';ctx.fillRect(this.x-5,this.y-5,this.width+10,this.height+10)}
if(Date.now()<this.burnEnd){ctx.fillStyle='rgba(230,126,34,0.2)';ctx.fillRect(this.x-3,this.y-3,this.width+6,this.height+6)}
if(this.sh){ctx.strokeStyle='rgba(100,200,255,0.6)';ctx.lineWidth=3;ctx.strokeRect(this.x-2,this.y-2,this.width+4,this.height+4)}
const hp=this.hp/this.mhp;ctx.fillStyle='rgba(0,0,0,0.6)';ctx.fillRect(this.x,this.y-10,this.width,5);ctx.fillStyle=hp>.5?'#4caf50':hp>.25?'#ff9800':'#f44336';ctx.fillRect(this.x,this.y-10,this.width*hp,5);
ctx.drawImage(s,this.x,this.y,this.width,this.height);ctx.restore()}}

// ===== EFFECTS =====
function cP(x,y,c,n){for(let i=0;i<n;i++)G_.par.push({x,y,vx:(Math.random()-.5)*6,vy:(Math.random()-.5)*6-2,life:30+Math.random()*20,ml:50,size:3+Math.random()*4,color:c})}
function uP(){G_.par=G_.par.filter(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=.1;p.life--;return p.life>0})}
function dP(){G_.par.forEach(p=>{ctx.globalAlpha=p.life/p.ml;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,p.size*(p.life/p.ml),0,Math.PI*2);ctx.fill()});ctx.globalAlpha=1}
function cDI(x,y,a,c){G_.di.push({x,y,text:'-'+a,life:40,color:c||'#ff6b6b'})}
function uDI(){G_.di=G_.di.filter(d=>{d.y-=1.5;d.life--;return d.life>0})}
function dDI(){G_.di.forEach(d=>{ctx.globalAlpha=d.life/40;ctx.fillStyle=d.color;ctx.font='bold 16px "Press Start 2P"';ctx.textAlign='center';ctx.fillText(d.text,d.x,d.y)});ctx.globalAlpha=1}
function showCombo(c){el.comboDisplay.textContent=c+'x COMBO!';el.comboDisplay.classList.remove('active');void el.comboDisplay.offsetWidth;el.comboDisplay.classList.add('active')}
function uProj(){G_.proj=G_.proj.filter(p=>{p.x+=p.vx;p.life-=.02;if(p.x<-50||p.x>C.W+50||p.life<=0)return false;if(p.isE){if(cc({x:p.x-p.size,y:p.y-p.size,width:p.size*2,height:p.size*2},P)){P.takeDmg(p.damage);return false}}else{for(let e of enemies){if(!e.dead&&cc({x:p.x-p.size,y:p.y-p.size,width:p.size*2,height:p.size*2},e)){e.takeDmg(p.damage);if(p.type==='ice'&&p.fc&&Math.random()<p.fc)e.freeze(C.V.fd);cP(p.x,p.y,p.type==='ice'?'#00bcd4':p.type==='energy'?'#4caf50':'#ffe082',5);return false}}}return true})}
function dProj(){G_.proj.forEach(p=>{ctx.save();if(p.isE){ctx.fillStyle='#a855f7';ctx.shadowColor='#a855f7';ctx.shadowBlur=10}else if(p.type==='ice'){ctx.fillStyle='#00bcd4';ctx.shadowColor='#00bcd4';ctx.shadowBlur=12}else if(p.type==='energy'){ctx.fillStyle='#4caf50';ctx.shadowColor='#4caf50';ctx.shadowBlur=12}else if(p.type==='bat'){ctx.fillStyle='#8b0000';ctx.shadowColor='#8b0000';ctx.shadowBlur=10}else if(p.type==='shield'){ctx.fillStyle='#2e7d32';ctx.shadowColor='#4caf50';ctx.shadowBlur=14}else if(p.type==='fire'){ctx.fillStyle='#ff6f00';ctx.shadowColor='#ff6f00';ctx.shadowBlur=14}else{ctx.fillStyle='#ffe082';ctx.shadowColor='#ffb300';ctx.shadowBlur=10}ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fill();ctx.restore()})}
function uSS(){if(G_.ssh.i>0){G_.ssh.x=(Math.random()-.5)*G_.ssh.i;G_.ssh.y=(Math.random()-.5)*G_.ssh.i;G_.ssh.i*=.9;if(G_.ssh.i<.5)G_.ssh.i=0}}
function spawnE(){const st=G_.cs;if(!st)return;if(enemies.filter(e=>!e.dead).length>=st.me)return;if(st.m.type==='kill'&&G_.sk>=st.m.target)return;const side=Math.random()>.5?1:-1;const types=st.et||['skeleton'];const type=types[Math.floor(Math.random()*types.length)];enemies.push(new Enemy(side===1?C.W+50:-60,st,type))}
function chkComplete(){const st=G_.cs;if(!st||G_.sc)return;if(st.m.type==='kill'&&G_.sk>=st.m.target&&enemies.filter(e=>!e.dead).length===0)showRes(1);if(st.m.type==='combo'&&G_.smc>=st.m.target)showRes(1)}

function showRes(v){G_.sc=1;G_.run=0;const st=G_.cs,el_=Math.floor((Date.now()-G_.sst)/1000);let xpG=0,ucN=null;
if(v){xpG=st.xp;if(G_.sdt===0)xpG+=50;if(G_.smc>=5)xpG+=30;const prev=G_.pl;G_.totalXp+=xpG;G_.ts+=G_.ssc;const l=XP.g(G_.totalXp);G_.pl=l.level;G_.cx=l.currentXp;G_.xn=l.neededXp;if(st.id>=G_.hs)G_.hs=st.id+1;let stars=1;if(G_.sdt===0)stars=3;else if(G_.sdt<30)stars=2;if(!G_.ss[st.id]||G_.ss[st.id]<stars)G_.ss[st.id]=stars;
save();snd.sc();el.resultsTitle.textContent='FASE COMPLETA!';el.resultsTitle.className='results-title victory';el.resultXp.textContent='+'+xpG+' XP';el.resultXp.style.display='block';el.resultLevelUp.style.display=G_.pl>prev?'block':'none';if(G_.pl>prev)snd.lu();
}else{snd.go();el.resultsTitle.textContent='DERROTA';el.resultsTitle.className='results-title defeat';el.resultXp.style.display='none';el.resultLevelUp.style.display='none'}
el.resultsGrid.innerHTML='<div class="result-card"><div class="result-card-value">'+st.n+'</div><div class="result-card-label">Fase</div></div><div class="result-card"><div class="result-card-value">'+G_.ssc.toLocaleString()+'</div><div class="result-card-label">Pontos</div></div><div class="result-card"><div class="result-card-value">'+G_.sk+'</div><div class="result-card-label">Derrotados</div></div><div class="result-card"><div class="result-card-value">'+G_.smc+'x</div><div class="result-card-label">Max Combo</div></div><div class="result-card"><div class="result-card-value">'+el_+'s</div><div class="result-card-label">Tempo</div></div><div class="result-card"><div class="result-card-value">'+G_.sdt+'</div><div class="result-card-label">Dano Recebido</div></div>';
el.resultUnlock.style.display='none';
el.resultsButtons.innerHTML='';
if(v){const nid=st.id+1;
if(nid>30){const b=document.createElement('button');b.className='game-btn game-btn-secondary';b.innerHTML='üó∫Ô∏è VOLTAR AO MAPA';b.addEventListener('click',()=>{hRes();showSS()});el.resultsButtons.appendChild(b)}
else{const b=document.createElement('button');b.className='game-btn game-btn-secondary';b.innerHTML='üó∫Ô∏è MAPA';b.addEventListener('click',()=>{hRes();showSS()});el.resultsButtons.appendChild(b);const n=document.createElement('button');n.className='game-btn game-btn-primary';n.innerHTML='PR√ìXIMA ‚Üí';n.addEventListener('click',()=>{hRes();startS(nid)});el.resultsButtons.appendChild(n)}
}else{const r=document.createElement('button');r.className='game-btn game-btn-danger';r.innerHTML='üîÑ RETRY';r.addEventListener('click',()=>{hRes();startS(st.id)});el.resultsButtons.appendChild(r);const m=document.createElement('button');m.className='game-btn game-btn-secondary';m.innerHTML='üó∫Ô∏è MAPA';m.addEventListener('click',()=>{hRes();showSS()});el.resultsButtons.appendChild(m)}
el.hudOverlay.style.display='none';el.stageIndicator.style.display='none';el.missionIndicator.style.display='none';el.supportCooldown.style.display='none';el.controlsPanel.style.display='none';el.fogOverlay.classList.remove('active');
setTimeout(()=>el.resultsScreen.classList.add('active'),v?1000:500)}
function hRes(){el.resultsScreen.classList.remove('active')}
function gOver(){G_.died=1;showRes(0)}

function uHUD(){el.healthBar.style.width=(P.hp/P.mhp)*100+'%';el.xpBar.style.width=(G_.cx/G_.xn)*100+'%';el.levelDisplay.textContent='Lv.'+G_.pl;const st=G_.cs;if(st&&st.m.type==='kill')el.killsDisplay.textContent=G_.sk+'/'+st.m.target;else if(st&&st.m.type==='survive'){const r=Math.max(0,st.m.target-Math.floor((Date.now()-G_.sst)/1000));el.killsDisplay.textContent=r+'s'}else el.killsDisplay.textContent=G_.sk;el.scoreDisplay.textContent=G_.ssc.toLocaleString();
if(G_.dit){const now=Date.now(),cd=Math.max(0,C.D.scd-(now-G_.lsT));el.supportCooldown.textContent=cd>0?'üõ°Ô∏è '+Math.ceil(cd/1000)+'s':'üõ°Ô∏è PRONTO';el.supportCooldown.style.color=cd>0?'#888':'#3498db'}}

function drawBg(){const bg=curBg;if(bg&&bg.complete&&bg.naturalWidth>0){const bh=bg.height||C.H;const scaleH=C.GY/bh;const sw=bg.width*scaleH;const off=G_.bo%sw;for(let i=-1;i<=Math.ceil(C.W/sw)+1;i++)ctx.drawImage(bg,off+i*sw,0,sw,C.GY)}else{const g=ctx.createLinearGradient(0,0,0,C.GY);g.addColorStop(0,'#1a2c4a');g.addColorStop(1,'#3d5a80');ctx.fillStyle=g;ctx.fillRect(0,0,C.W,C.GY)}
ctx.fillStyle='#3a5a40';ctx.fillRect(0,C.GY,C.W,C.H-C.GY);ctx.fillStyle='#588157';for(let i=0;i<35;i++){const x=((i*40+G_.bo*.5)%(C.W+50))-25;ctx.fillRect(x,C.GY-3,25,8)}ctx.strokeStyle='#4a7a5a';ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(0,C.GY);ctx.lineTo(C.W,C.GY);ctx.stroke()}

let lt=0;
function loop(ts){if(!G_.run)return;const dt=ts-lt;lt=ts;if(G_.pau||G_.sc){requestAnimationFrame(loop);return}
ctx.clearRect(0,0,C.W,C.H);ctx.save();ctx.translate(G_.ssh.x,G_.ssh.y);
P.update(dt);sarah.update();dani.update();alice.update();vitoria.update();miguel.update();lilia.update();isabela.update();gabriel.update();luccas.update();manuh.update();julia.update();agatha.update();poiqui.update();yasmim.update();
enemies.forEach(e=>e.update());uP();uDI();uSS();uProj();
const now=Date.now();if(G_.aBuf&&now>G_.aBufE)G_.aBuf=0;if(G_.iSh&&now>G_.iShE)G_.iSh=0;if(G_.fCA&&now>G_.fCE)G_.fCA=0;if(G_.lcSh&&now>G_.lcShE)G_.lcSh=0;if(G_.pqAura&&now>G_.pqAuraE)G_.pqAura=0;
G_.bo-=P.vx*.3;const st=G_.cs;if(st&&now-G_.lsp>st.sr){spawnE();G_.lsp=now}if(now-G_.lct>2000&&G_.co>0)G_.co=0;
if(st&&st.m.type==='survive'&&(now-G_.sst)/1000>=st.m.target)showRes(1);
uHUD();drawBg();enemies.forEach(e=>e.draw());dani.draw();alice.draw();vitoria.draw();lilia.draw();miguel.draw();isabela.draw();gabriel.draw();luccas.draw();manuh.draw();julia.draw();agatha.draw();poiqui.draw();yasmim.draw();sarah.draw();P.draw();dProj();dP();dDI();
ctx.restore();requestAnimationFrame(loop)}

// Primary character attack with cooldowns
const CA_CD={lia:400,sarah:600,dani:15000,alice:8000,vitoria:12000,miguel:800,lilia:10000,isabela:8000,gabriel:8000,luccas:12000,manuh:6000,julia:9000,agatha:10000,poiqui:7000,yasmim:10000};
const CA={
lia:{icon:'‚öî',css:'attack-lia',fn:()=>P.attack()},
sarah:{icon:'‚ú¶',css:'attack-sarah',fn:()=>{const now=Date.now();if(now-G_.pAtkLast<CA_CD.sarah)return;G_.pAtkLast=now;const a=enemies.filter(e=>!e.dead);if(a.length>0){const n=a.reduce((x,y)=>Math.abs(x.x-P.x)<Math.abs(y.x-P.x)?x:y);let d=C.S.ba+XP.b(G_.pl,'attack')*.5;G_.proj.push({x:P.x+P.w/2,y:P.y+P.h/2,vx:(n.x>P.x?1:-1)*C.S.ps,damage:d,life:1,size:8,type:'light'});snd.shoot()}}},
dani:{icon:'üõ°',css:'attack-dani',fn:()=>{const now=Date.now();if(now-G_.pAtkLast<CA_CD.dani)return;G_.pAtkLast=now;syncToP(dani);dani.activateShield()}},
alice:{icon:'üî•üî•',css:'attack-alice',fn:()=>{const now=Date.now();if(now-G_.pAtkLast<CA_CD.alice)return;G_.pAtkLast=now;syncToP(alice);alice.fireAttack();alice.lat=now}},
vitoria:{icon:'‚ùÑ',css:'attack-vitoria',fn:()=>{const now=Date.now();if(now-G_.pAtkLast<CA_CD.vitoria)return;G_.pAtkLast=now;syncToP(vitoria);vitoria.s2()}},
miguel:{icon:'üî´',css:'attack-miguel',fn:()=>{const now=Date.now();if(now-G_.pAtkLast<CA_CD.miguel)return;G_.pAtkLast=now;syncToP(miguel);miguel.shoot();miguel.lat=now}},
lilia:{icon:'üîÆ',css:'attack-lilia',fn:()=>{const now=Date.now();if(now-G_.pAtkLast<CA_CD.lilia)return;G_.pAtkLast=now;syncToP(lilia);lilia.purpleBurst();lilia.lat=now}},
isabela:{icon:'ü¶á',css:'attack-isabela',fn:()=>{const now=Date.now();if(now-G_.pAtkLast<CA_CD.isabela)return;G_.pAtkLast=now;syncToP(isabela);isabela.batSwarm();isabela.lat=now}},
gabriel:{icon:'üõ°Ô∏è',css:'attack-gabriel',fn:()=>{const now=Date.now();if(now-G_.pAtkLast<CA_CD.gabriel)return;G_.pAtkLast=now;syncToP(gabriel);gabriel.reflect();gabriel.lat=now}},
luccas:{icon:'üü¢',css:'attack-luccas',fn:()=>{const now=Date.now();if(now-G_.pAtkLast<CA_CD.luccas)return;G_.pAtkLast=now;syncToP(luccas);luccas.throwShield();luccas.lat1=now}},
manuh:{icon:'üó°Ô∏è',css:'attack-manuh',fn:()=>{const now=Date.now();if(now-G_.pAtkLast<CA_CD.manuh)return;G_.pAtkLast=now;syncToP(manuh);manuh.iceSlash();manuh.lat=now}},
julia:{icon:'üî•',css:'attack-julia',fn:()=>{const now=Date.now();if(now-G_.pAtkLast<CA_CD.julia)return;G_.pAtkLast=now;syncToP(julia);julia.flameBurst();julia.lat=now}},
agatha:{icon:'‚ú®',css:'attack-agatha',fn:()=>{const now=Date.now();if(now-G_.pAtkLast<CA_CD.agatha)return;G_.pAtkLast=now;syncToP(agatha);agatha.lightBeam();agatha.lat=now}},
poiqui:{icon:'üî•',css:'attack-poiqui',fn:()=>{const now=Date.now();if(now-G_.pAtkLast<CA_CD.poiqui)return;G_.pAtkLast=now;syncToP(poiqui);poiqui.flameBlast();poiqui.lat1=now}},
yasmim:{icon:'üí•',css:'attack-yasmim',fn:()=>{const now=Date.now();if(now-G_.pAtkLast<CA_CD.yasmim)return;G_.pAtkLast=now;syncToP(yasmim);yasmim.dualExplosion();yasmim.lat=now}}
};
function uMAB(){const b=document.getElementById('mobileAttack'),i=CA[G_.pc]||CA.lia;b.textContent=i.icon;b.className='mobile-btn '+i.css;
// Update cooldown display
const cd=CA_CD[G_.pc]||400,now=Date.now(),rem=Math.max(0,cd-(now-G_.pAtkLast));
if(rem>0){b.classList.add('on-cooldown')}else{b.classList.remove('on-cooldown')}}
function pAtk(){(CA[G_.pc]||CA.lia).fn()}

function startS(id){iA();const st=SD.find(s=>s.id===id);if(!st||id>G_.hs)return;
G_.cs=st;G_.run=1;G_.pau=0;G_.sc=0;G_.died=0;G_.sk=0;G_.ssc=0;G_.sdt=0;G_.smc=0;G_.co=0;G_.lct=0;G_.lsp=Date.now();G_.lsT=0;G_.sst=Date.now();G_.bo=0;G_.par=[];G_.di=[];G_.proj=[];G_.ssh={x:0,y:0,i:0};G_.shA=0;G_.shE=0;G_.aBuf=0;G_.aBufE=0;G_.iSh=0;G_.iShE=0;G_.fCA=0;G_.fCE=0;G_.fCC=0;G_.lcSh=0;G_.lcShHP=0;G_.lcShE=0;G_.pqAura=0;G_.pqAuraE=0;G_.pAtkLast=0;G_.fog=!!st.fog;G_.slow=!!st.slow;
el.fogOverlay.classList.toggle('active',G_.fog);
curBg=img[getBg(id)]||img.background;
G_.pc=G_.sel[0]||'lia';
G_.sit=G_.sel.includes('sarah')&&G_.pc!=='sarah'?1:0;
G_.dit=G_.sel.includes('dani')&&G_.pc!=='dani'?1:0;
G_.ait=G_.sel.includes('alice')&&G_.pc!=='alice'?1:0;
G_.vit=G_.sel.includes('vitoria')&&G_.pc!=='vitoria'?1:0;
G_.mit=G_.sel.includes('miguel')&&G_.pc!=='miguel'?1:0;
G_.lit=G_.sel.includes('lilia')&&G_.pc!=='lilia'?1:0;
G_.ibt=G_.sel.includes('isabela')&&G_.pc!=='isabela'?1:0;
G_.gbt=G_.sel.includes('gabriel')&&G_.pc!=='gabriel'?1:0;
G_.lut=G_.sel.includes('luccas')&&G_.pc!=='luccas'?1:0;
G_.mnt=G_.sel.includes('manuh')&&G_.pc!=='manuh'?1:0;
G_.jut=G_.sel.includes('julia')&&G_.pc!=='julia'?1:0;
G_.agt=G_.sel.includes('agatha')&&G_.pc!=='agatha'?1:0;
G_.pqt=G_.sel.includes('poiqui')&&G_.pc!=='poiqui'?1:0;
G_.yat=G_.sel.includes('yasmim')&&G_.pc!=='yasmim'?1:0;
uMAB();
P.reset();sarah.reset();dani.reset();alice.reset();vitoria.reset();miguel.reset();lilia.reset();isabela.reset();gabriel.reset();luccas.reset();manuh.reset();julia.reset();agatha.reset();poiqui.reset();yasmim.reset();enemies=[];
el.stageSelectScreen.classList.remove('active');el.resultsScreen.classList.remove('active');el.hudOverlay.style.display='flex';el.stageIndicator.style.display='block';el.stageIndicator.textContent='FASE '+st.n;el.missionIndicator.style.display='block';el.missionIndicator.textContent=st.m.text;el.controlsPanel.style.display=window.innerWidth>768?'grid':'none';el.supportCooldown.style.display=G_.dit?'block':'none';uHUD();lt=performance.now();requestAnimationFrame(loop)}
function tPause(){if(!G_.run||G_.sc)return;G_.pau=!G_.pau;el.pauseOverlay.classList.toggle('active',G_.pau)}

let cW=1,selS=1;
function rWT(){el.worldTabs.innerHTML='';const t=document.createElement('button');t.className='world-tab active';t.textContent='üå≤ Magewood Forest';el.worldTabs.appendChild(t)}
function rSG(){el.stageGrid.innerHTML='';SD.forEach(st=>{const n=document.createElement('div');n.className='stage-node';const u=st.id<=G_.hs,c=G_.ss[st.id]>0,ic=st.id===G_.hs;if(c)n.classList.add('completed');else if(u){n.classList.add('unlocked');if(ic)n.classList.add('current')}else n.classList.add('locked');n.innerHTML='<div class="stage-number">'+st.sw+'</div><div class="stage-stars">'+('‚≠ê'.repeat(G_.ss[st.id]||0))+'</div>';if(u)n.addEventListener('click',()=>selStage(st.id));el.stageGrid.appendChild(n)})}
function selStage(id){selS=id;const s=SD.find(x=>x.id===id);if(!s)return;el.stageInfoPanel.style.display='block';el.stageInfoTitle.textContent='FASE '+s.n+' - '+s.wn;el.stageInfoMission.textContent=s.m.text;el.stageXpReward.textContent=s.xp;el.stageScoreReward.textContent=s.sc;rTS()}
function rTS(){el.teamSelectMini.innerHTML='';
const chars=[{id:'lia',n:'Lia',r:'Atacante',i:'lia.png'},{id:'sarah',n:'Sarah',r:'Atacante',i:'sarah.png'},{id:'dani',n:'Dani',r:'Defensora',i:'dani.png'},{id:'alice',n:'Alice',r:'Suporteüî•',i:'alice.png'},{id:'vitoria',n:'Vit√≥ria',r:'Suporte‚ùÑÔ∏è',i:'vitoria.png'},{id:'miguel',n:'Miguel',r:'Atirador',i:'miguel.png'},{id:'lilia',n:'Lilia',r:'Criativa',i:'lilia.png'},{id:'isabela',n:'Isabela',r:'Atacanteü¶á',i:'isabela.png'},{id:'gabriel',n:'Gabriel',r:'Defensorüõ°Ô∏è',i:'gabriel.png'},{id:'luccas',n:'Luccas',r:'Criativoüü¢',i:'luccas.png'},{id:'manuh',n:'Manuh',r:'Criativaüó°Ô∏è',i:'manuh.png'},{id:'julia',n:'Julia',r:'Suporteüî•',i:'julia.png'},{id:'agatha',n:'Agatha',r:'Atacante‚ú®',i:'agatha.png'},{id:'poiqui',n:'Poiqui',r:'Atacanteüî•',i:'poiqui.png'},{id:'yasmim',n:'Yasmim',r:'Defensorüí•',i:'yasmim.png'}];
chars.forEach(c=>{
const div=document.createElement('div'),idx=G_.sel.indexOf(c.id),ip=idx===0,sel=idx>=0;
div.className='team-char-mini'+(sel?' selected':'')+(ip?' primary-char':'');
div.innerHTML='<img src="'+c.i+'" alt="'+c.n+'"><div class="cn">'+(ip?'‚òÖ ':'')+c.n+'</div><div class="cr">'+c.r+'</div>';
div.addEventListener('click',()=>{const ci=G_.sel.indexOf(c.id);if(ci>=0){if(G_.sel.length>1)G_.sel.splice(ci,1);} else if(G_.sel.length<3)G_.sel.push(c.id);rTS()});
div.addEventListener('dblclick',()=>{const ci=G_.sel.indexOf(c.id);if(ci>0){G_.sel.splice(ci,1);G_.sel.unshift(c.id)}else if(ci<0&&G_.sel.length<3){G_.sel.unshift(c.id)}rTS()});
el.teamSelectMini.appendChild(div)})}
function uPS(){el.playerLevelStat.textContent='Lv. '+G_.pl;el.playerXpStat.textContent=G_.totalXp.toLocaleString();let t=0;Object.values(G_.ss).forEach(s=>t+=s);el.playerStarsStat.textContent=t}
function showSS(){uPS();rWT();rSG();el.mainMenuScreen.classList.remove('active');el.resultsScreen.classList.remove('active');el.stageSelectScreen.classList.add('active');el.hudOverlay.style.display='none';el.stageIndicator.style.display='none';el.missionIndicator.style.display='none';el.supportCooldown.style.display='none';el.controlsPanel.style.display='none';el.fogOverlay.classList.remove('active');selStage(Math.min(G_.hs,30))}

document.addEventListener('keydown',e=>{const k=e.key.toLowerCase();G_.keys[k]=1;if(!G_.run)return;if((k==='w'||k===' '||k==='arrowup')&&!G_.pau){P.jump();e.preventDefault()}if(k==='j'&&!G_.pau)pAtk();if(k==='k'&&!G_.pau){if(G_.dit)dani.activateShield();else if(G_.vit)vitoria.s2()}if(k==='l'&&!G_.pau&&G_.vit)vitoria.s3();if(k==='escape'||k==='p')tPause();if([' ','arrowup','arrowdown','arrowleft','arrowright'].includes(k))e.preventDefault()});
document.addEventListener('keyup',e=>{const k=e.key.toLowerCase();G_.keys[k]=0;if(k==='w'||k===' '||k==='arrowup')P.rj()});

function setupM(){const ts=(k,a)=>e=>{e.preventDefault();G_.keys[k]=1;if(a)a()},te=(k,a)=>e=>{e.preventDefault();G_.keys[k]=0;if(a)a()};
document.getElementById('mobileLeft').addEventListener('touchstart',ts('a'));document.getElementById('mobileLeft').addEventListener('touchend',te('a'));
document.getElementById('mobileRight').addEventListener('touchstart',ts('d'));document.getElementById('mobileRight').addEventListener('touchend',te('d'));
document.getElementById('mobileJump').addEventListener('touchstart',ts('jump',()=>P.jump()));document.getElementById('mobileJump').addEventListener('touchend',te('jump',()=>P.rj()));
document.getElementById('mobileAttack').addEventListener('touchstart',ts('atk',()=>pAtk()));document.getElementById('mobileAttack').addEventListener('touchend',te('atk'))}

document.getElementById('titleStartBtn').addEventListener('click',()=>{iA();el.titleScreen.classList.remove('active');el.mainMenuScreen.classList.add('active')});
document.getElementById('playGameBtn').addEventListener('click',showSS);
document.getElementById('googleLoginBtn').addEventListener('click',()=>alert('Login com Google ser√° implementado em breve!\nSem login, seus dados N√ÉO ser√£o salvos ao fechar o jogo.'));
document.getElementById('backToMenuBtn').addEventListener('click',()=>{el.stageSelectScreen.classList.remove('active');el.mainMenuScreen.classList.add('active')});
document.getElementById('playStageBtn').addEventListener('click',()=>startS(selS));
setupM();G_.sel=['lia'];if('ontouchstart' in window)el.mobileControls.style.display='flex';
</script>
</body>
</html>
